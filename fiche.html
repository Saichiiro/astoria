<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche de personnage</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fiche.css">
</head>
<body>
    <main class="fiche-page" aria-labelledby="fichePageTitle">
        <header class="page-header">
            <a href="index.html" class="magic-back-link" title="Retour √† l'accueil">‚Üê Retour</a>
            <div class="page-header-main">
                <div class="page-title-block">
                    <h1 class="page-title" id="fichePageTitle">Fiche de personnage</h1>
                    <p class="page-subtitle">Identit√©, appartenances, magies et histoire du personnage.</p>
                </div>
                <div class="character-summary" aria-label="R√©sum√© du personnage">
                    <div class="character-avatar-wrapper">
                        <div class="character-avatar character-avatar--clickable" role="button" tabindex="0" aria-haspopup="true" aria-label="Changer de personnage">
                            <img class="character-avatar-img" id="characterSummaryAvatar" alt="Avatar" hidden>
                            <div class="character-avatar-circle" id="characterSummaryInitial"></div>
                        </div>
                        <div class="character-dropdown" hidden aria-label="S√©lectionner un personnage"></div>
                    </div>
                    <div class="character-summary-text">
                        <a class="character-name" id="characterSummaryName" href="profil.html">Nom du personnage</a>
                        <span class="character-tagline" id="characterSummaryTagline">Classe / R√¥le / Surnom</span>
                    </div>
                </div>
            </div>
        </header>

        <section class="fiche-container">
            <!-- Navigation (onglets) -->
            <nav class="fiche-sidebar" aria-label="Sections de la fiche">
                <button type="button" class="tab-button active" data-tab="identite">Identit√©</button>
                <button type="button" class="tab-button" data-tab="appartenance">Appartenance</button>
                <button type="button" class="tab-button" data-tab="combat">Combat</button>
                <button type="button" class="tab-button" data-tab="alice">Alice</button>
                <button type="button" class="tab-button" data-tab="sorcellerie">Sorcellerie</button>
                <button type="button" class="tab-button" data-tab="eater">Eater</button>
                <button type="button" class="tab-button" data-tab="religion">Religion</button>
                <button type="button" class="tab-button" data-tab="mental">Mental</button>
                <button type="button" class="tab-button" data-tab="physique">Physique</button>
                <button type="button" class="tab-button" data-tab="background">Background</button>
            </nav>

            <!-- Contenu -->
            <section class="fiche-content" aria-live="polite">
                <form class="fiche-form">
                    <!-- Identit√© -->
                    <section id="tab-identite" class="tab-panel active" aria-label="Identit√©">
                        <div class="tab-panel-header">
                            <h2 class="section-title section-title--inline">Identit√©</h2>
                            <button type="button" class="save-tab-button" data-tab="identite">Sauvegarder</button>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="identiteNomPrenom">Nom &amp; pr√©nom</label>
                            <input
                                id="identiteNomPrenom"
                                class="field-input"
                                type="text"
                                placeholder="Nom complet, titres √©ventuels et patronymes (la noblesse peut avoir un nom long)."
                            >
                        </div>

                        <div class="field-group field-group--inline">
                            <div class="field-group">
                                <label class="field-label" for="identiteAge">√Çge</label>
                                <input id="identiteAge" class="field-input" type="text" placeholder="Ex : 17 ans">
                            </div>
                            <div class="field-group">
                                <label class="field-label" for="identiteSexe">Sexe</label>
                                <input id="identiteSexe" class="field-input" type="text" placeholder="Sexe / genre du personnage">
                            </div>
                        </div>

                        <div class="field-group field-group--inline">
                            <div class="field-group">
                                <label class="field-label" for="identiteRace">Race</label>
                                <input id="identiteRace" class="field-input" type="text" placeholder="Race ou esp√®ce (humaine, hybride, etc.)">
                            </div>
                            <div class="field-group">
                                <label class="field-label" for="identiteHierarchieSociale">Hi√©rarchie sociale</label>
                                <input id="identiteHierarchieSociale" class="field-input" type="text" placeholder="Noble, roturier, famille influente, etc.">
                            </div>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="identitePaysOrigine">Pays d'origine</label>
                            <input id="identitePaysOrigine" class="field-input" type="text" placeholder="Royaume / pays / r√©gion d'origine.">
                        </div>
                        <div class="field-group">
                            <div class="relations-header">
                                <label class="field-label">Liens &amp; relations</label>
                                <button type="button" class="relation-add-btn" id="addBackgroundRelation">+ Ajouter un lien</button>
                            </div>
                            <div class="relations-list" id="backgroundRelations"></div>
                            <p class="relations-hint">
                                Ajoute un ID de personnage pour cr√©er un lien direct vers son profil (optionnel).
                            </p>
                        </div>
                    </section>

                    <!-- Appartenance -->
                    <section id="tab-appartenance" class="tab-panel" aria-label="Appartenance">
                        <div class="tab-panel-header">
                            <h2 class="section-title section-title--inline">Appartenance</h2>
                            <button type="button" class="save-tab-button" data-tab="appartenance">Sauvegarder</button>
                        </div>

                        <div class="field-group field-group--inline">
                            <div class="field-group">
                                <label class="field-label" for="appRole">R√¥le</label>
                                <select id="appRole" class="field-input">
                                    <option value="">S√©lectionner...</option>
                                    <option value="eleve">√âl√®ve</option>
                                    <option value="adulte">Adulte</option>
                                </select>
                            </div>
                            <div class="field-group">
                                <label class="field-label" for="appNiveauScolaire">Niveau scolaire</label>
                                <select id="appNiveauScolaire" class="field-input">
                                    <option value="">S√©lectionner...</option>
                                    <option value="maternelle">Maternelle</option>
                                    <option value="college">Coll√®ge</option>
                                    <option value="lycee">Lyc√©e</option>
                                    <option value="universite">Universit√©</option>
                                </select>
                            </div>
                        </div>

                        <div class="field-group field-group--inline">
                            <div class="field-group">
                                <label class="field-label" for="appAffection">Affection</label>
                                <select id="appAffection" class="field-input">
                                    <option value="">S√©lectionner...</option>
                                    <option value="civil">Civil</option>
                                    <option value="sorcier">Sorcier</option>
                                    <option value="eater">Eater</option>
                                    <option value="alice">Alice</option>
                                </select>
                            </div>
                            <div class="field-group">
                                <label class="field-label" for="appRangEtoile">Rang √©toil√©</label>
                                <select id="appRangEtoile" class="field-input">
                                    <option value="">S√©lectionner...</option>
                                    <option value="sans-etoile">‚îÉ‚îú„Äà‚≠ê„Äã‚ù±‚Üí Sans √©toile</option>
                                    <option value="simple">‚îÉ‚îú„Äà‚≠ê„Äã‚ù±‚Üí Simple</option>
                                    <option value="double">‚îÉ‚îú„Äà‚≠ê„Äã‚ù±‚Üí Double</option>
                                    <option value="triple">‚îÉ‚îú„Äà‚≠ê„Äã‚ù±‚Üí Triple</option>
                                    <option value="major">‚îÉ‚îú„Äàüåü„Äã‚ù±‚Üí Major</option>
                                </select>
                            </div>
                        </div>

                        <div class="field-group field-group--inline">
                            <div class="field-group">
                                <label class="field-label" for="appHouse">House</label>
                                <select id="appHouse" class="field-input">
                                    <option value="">S√©lectionner...</option>
                                    <option value="red-spider">‚îÉ‚îú„Äàüï∑Ô∏è„Äã‚ù±‚Üí Red Spider House</option>
                                    <option value="blue-bear">‚îÉ‚îú„Äàüêª„Äã‚ù±‚Üí Blue Bear House</option>
                                    <option value="violet-goat">‚îÉ‚îú„Äàüêê„Äã‚ù±‚Üí Violet Goat House</option>
                                    <option value="green-turtle">‚îÉ‚îú„Äàüê¢„Äã‚ù±‚Üí Green Turtle House</option>
                                </select>
                            </div>
                            <div class="field-group">
                                <label class="field-label" for="appHierarchie">Hi√©rarchie</label>
                                <input
                                    id="appHierarchie"
                                    class="field-input"
                                    type="text"
                                    placeholder="Intendant, pr√©fet, √©tudiant, membre du staff, etc."
                                >
                            </div>
                        </div>
                    </section>

                    <!-- Combat -->
                    <section id="tab-combat" class="tab-panel" aria-label="Combat">
                        <div class="tab-panel-header">
                            <h2 class="section-title section-title--inline">Combat</h2>
                            <button type="button" class="save-tab-button" data-tab="combat">Sauvegarder</button>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="combatStyle">Style de combat</label>
                            <textarea
                                id="combatStyle"
                                class="field-input field-textarea"
                                rows="5"
                                placeholder="D√©crivez le style de combat global : posture, philosophie, forces et faiblesses."
                            ></textarea>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="combatTechniques">Techniques actuelles</label>
                            <textarea
                                id="combatTechniques"
                                class="field-input field-textarea"
                                rows="5"
                                placeholder="Maximum 3 techniques, sans magie (attaques physiques, parades, styles martiaux...)."
                            ></textarea>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="combatArme">Type d'arme</label>
                            <input
                                id="combatArme"
                                class="field-input"
                                type="text"
                                placeholder="Type d'arme principale : √©p√©e, faux, arme improvis√©e, etc."
                            >
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="combatArmeImage">Image de l'arme (URL)</label>
                            <input
                                id="combatArmeImage"
                                class="field-input"
                                type="url"
                                placeholder="Lien vers une illustration de l'arme (optionnel)."
                            >
                        </div>
                    </section>

                    <!-- Alice -->
                    <section id="tab-alice" class="tab-panel" aria-label="Alice">
                        <div class="tab-panel-header">
                            <h2 class="section-title section-title--inline">Alice</h2>
                            <button type="button" class="save-tab-button" data-tab="alice">Sauvegarder</button>
                        </div>

                        <div class="alice-toggle-row">
                            <label class="alice-toggle-label">
                                <input id="hasAlice" type="checkbox">
                                <span>Poss√®de une Alice</span>
                            </label>
                            <label class="alice-toggle-label">
                                <input id="hasDoubleAlice" type="checkbox">
                                <span>Poss√®de un Double Alice</span>
                            </label>
                        </div>

                        <div id="alice-container" class="alice-grid">
                            <div id="alice-fields" class="conditional-block">
                                <h3 class="alice-subtitle">Alice principale</h3>
                                <div class="field-group">
                                    <label class="field-label" for="aliceNom">Nom de l'Alice</label>
                                    <input id="aliceNom" class="field-input" type="text" placeholder="Nom ou titre de l'Alice.">
                                </div>

                                <div class="field-group">
                                    <label class="field-label" for="aliceType">Type</label>
                                    <input
                                        id="aliceType"
                                        class="field-input"
                                        type="text"
                                        placeholder="Type d'Alice : physiologique, mentale, √©l√©mentaire, etc."
                                    >
                                </div>

                                <div class="field-group">
                                    <label class="field-label" for="aliceForme">Forme</label>
                                    <input
                                        id="aliceForme"
                                        class="field-input"
                                        type="text"
                                        placeholder="Forme(s) ou modalit√©s d'expression de l'Alice."
                                    >
                                </div>

                                <div class="field-group">
                                    <label class="field-label" for="aliceFiche">Fiche compl√®te (URL)</label>
                                    <input
                                        id="aliceFiche"
                                        class="field-input"
                                        type="url"
                                        placeholder="Lien vers la fiche d√©taill√©e de l'Alice (si s√©par√©e)."
                                    >
                                </div>
                            </div>

                            <div id="alice2-fields" class="conditional-block alice-secondary-fields">
                                <h3 class="alice-subtitle">Double Alice</h3>
                                <div class="field-group">
                                    <label class="field-label" for="alice2Nom">Nom de l'Alice</label>
                                    <input id="alice2Nom" class="field-input" type="text" placeholder="Nom ou titre de l'Alice.">
                                </div>

                                <div class="field-group">
                                    <label class="field-label" for="alice2Type">Type</label>
                                    <input
                                        id="alice2Type"
                                        class="field-input"
                                        type="text"
                                        placeholder="Type d'Alice : physiologique, mentale, √©l√©mentaire, etc."
                                    >
                                </div>

                                <div class="field-group">
                                    <label class="field-label" for="alice2Forme">Forme</label>
                                    <input
                                        id="alice2Forme"
                                        class="field-input"
                                        type="text"
                                        placeholder="Forme(s) ou modalit√©s d'expression de l'Alice."
                                    >
                                </div>

                                <div class="field-group">
                                    <label class="field-label" for="alice2Fiche">Fiche compl√®te (URL)</label>
                                    <input
                                        id="alice2Fiche"
                                        class="field-input"
                                        type="url"
                                        placeholder="Lien vers la fiche d√©taill√©e de l'Alice (si s√©par√©e)."
                                    >
                                </div>
                            </div>
                        </div>

                    </section>

                    <!-- Sorcellerie -->
                    <section id="tab-sorcellerie" class="tab-panel" aria-label="Sorcellerie">
                        <div class="tab-panel-header">
                            <h2 class="section-title section-title--inline">Sorcellerie</h2>
                            <button type="button" class="save-tab-button" data-tab="sorcellerie">Sauvegarder</button>
                        </div>

                        <div class="field-group">
                            <label class="field-label">
                                <input id="hasMagic" type="checkbox">
                                Poss√®de de la magie
                            </label>
                        </div>

                        <div id="sorcellerie-fields" class="conditional-block" hidden>
                            <p class="fiche-hint">Deblocage par parchemins d'eveil et tags Sorcier: stub en cours.</p>
                            <div class="field-group">
                                <label class="field-label" for="sorcelleriePrincipale">Magie principale</label>
                                <input
                                    id="sorcelleriePrincipale"
                                    class="field-input"
                                    type="text"
                                    placeholder="Sp√©cialisation principale (ex : feu, soin, gravit√©...)."
                                >
                            </div>

                            <div class="field-group">
                                <label class="field-label" for="sorcellerieSecondaire">Magie secondaire</label>
                                <input
                                    id="sorcellerieSecondaire"
                                    class="field-input"
                                    type="text"
                                    placeholder="Magie secondaire √©ventuelle (optionnelle)."
                                >
                            </div>

                            <div class="field-group">
                                <label class="field-label" for="sorcellerieCachee">Magie cach√©e</label>
                                <input
                                    id="sorcellerieCachee"
                                    class="field-input"
                                    type="text"
                                    placeholder="Magie cach√©e ou en latence (si connue de l'√©quipe)."
                                >
                            </div>

                            <div class="field-group">
                                <label class="field-label" for="sorcelleriePotentiel">Potentiel magique</label>
                                <input
                                    id="sorcelleriePotentiel"
                                    class="field-input"
                                    type="number"
                                    min="0"
                                    inputmode="numeric"
                                    placeholder="Score de potentiel magique."
                                >
                            </div>

                            <div class="magie-sup-actions">
                                <button type="button" id="addMagieSupplementaire" class="btn-secondary">+ Ajouter une magie suppl√©mentaire</button>
                            </div>

                            <div id="magie-supplementaire-container"></div>
                        </div>
                    </section>

                    <!-- Eater -->
                    <section id="tab-eater" class="tab-panel" aria-label="Eater">
                        <div class="tab-panel-header">
                            <h2 class="section-title section-title--inline">Eater</h2>
                            <button type="button" class="save-tab-button" data-tab="eater">Sauvegarder</button>
                        </div>

                        <div class="field-group">
                            <label class="field-label">
                                <input id="hasEater" type="checkbox">
                                Poss√®de une capacit√© d'√¢me
                            </label>
                        </div>

                        <div id="eater-fields" class="conditional-block" hidden>
                            <!-- Soul Counter Panel -->
                            <div class="eater-counter">
                                <h3 class="eater-counter-title">Compteur d'√¢mes</h3>
                                <p class="fiche-hint">Lien automatique avec l'inventaire (ames) : stub.</p>
                                <div class="field-group field-group--inline">
                                    <div class="field-group">
                                        <label class="field-label" for="eaterAmesConso">√Çmes de Consommation</label>
                                        <input
                                            id="eaterAmesConso"
                                            class="field-input"
                                            type="number"
                                            min="0"
                                            placeholder="0"
                                        >
                                    </div>
                                    <div class="field-group">
                                        <label class="field-label" for="eaterAmesProgression">√Çmes de Progression</label>
                                        <input
                                            id="eaterAmesProgression"
                                            class="field-input"
                                            type="number"
                                            min="0"
                                            placeholder="0"
                                        >
                                    </div>
                                </div>
                            </div>

                            <div class="field-group">
                                <label class="field-label" for="eaterRole">R√¥le</label>
                                <select id="eaterRole" class="field-input">
                                    <option value="">S√©lectionner...</option>
                                    <option value="meister">Meister</option>
                                    <option value="weapon">Weapon</option>
                                </select>
                            </div>

                            <div class="field-group">
                                <label class="field-label" for="eaterTypeArme">Type d'arme</label>
                                <select id="eaterTypeArme" class="field-input">
                                    <option value="">S√©lectionner...</option>
                                    <option value="classique">Classique</option>
                                    <option value="multi-formes">Multi-formes</option>
                                    <option value="jumelees">Jumel√©es</option>
                                </select>
                            </div>

                            <div class="field-group">
                                <label class="field-label" for="eaterDescriptionArme">Description de l'arme</label>
                                <textarea
                                    id="eaterDescriptionArme"
                                    class="field-input field-textarea"
                                    rows="4"
                                    placeholder="Description d√©taill√©e de l'arme, de ses formes et particularit√©s."
                                ></textarea>
                            </div>

                            <div class="field-group">
                                <label class="field-label" for="eaterImageArme">Image de l'arme (URL)</label>
                                <input
                                    id="eaterImageArme"
                                    class="field-input"
                                    type="url"
                                    placeholder="Lien vers une illustration de l'arme (optionnel)."
                                >
                            </div>

                            <div class="field-group">
                                <label class="field-label" for="eaterNoyau">Capacit√© unique [Noyau]</label>
                                <textarea
                                    id="eaterNoyau"
                                    class="field-input field-textarea"
                                    rows="4"
                                    placeholder="Capacit√© centrale li√©e au noyau de l'√¢me."
                                ></textarea>
                            </div>

                            <div class="field-group">
                                <label class="field-label" for="eaterFragments">Capacit√© unique [Fragments]</label>
                                <textarea
                                    id="eaterFragments"
                                    class="field-input field-textarea"
                                    rows="4"
                                    placeholder="√Ä remplir seulement si acquis (fragment(s) li√©s au noyau)."
                                ></textarea>
                            </div>
                        </div>
                    </section>

                    <!-- Religion -->
                    <section id="tab-religion" class="tab-panel" aria-label="Religion">
                        <div class="tab-panel-header">
                            <h2 class="section-title section-title--inline">Religion</h2>
                            <button type="button" class="save-tab-button" data-tab="religion">Sauvegarder</button>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="religionCroyance">Croyance</label>
                            <textarea
                                id="religionCroyance"
                                class="field-input field-textarea"
                                rows="3"
                                placeholder="Religion, panth√©on ou croyance principale du personnage."
                            ></textarea>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="religionProphetie">Proph√©tie</label>
                            <textarea
                                id="religionProphetie"
                                class="field-input field-textarea"
                                rows="3"
                                placeholder="Proph√©tie, pr√©sage ou destin√©e annonc√©e (le cas √©ch√©ant)."
                            ></textarea>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="religionBenediction">B√©n√©diction</label>
                            <textarea
                                id="religionBenediction"
                                class="field-input field-textarea"
                                rows="3"
                                placeholder="B√©n√©dictions divines, protections, dons particuliers."
                            ></textarea>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="religionMalediction">Mal√©diction</label>
                            <textarea
                                id="religionMalediction"
                                class="field-input field-textarea"
                                rows="3"
                                placeholder="Mal√©dictions, pactes, contreparties, stigmates."
                            ></textarea>
                        </div>
                    </section>

                    <!-- Mental -->
                    <section id="tab-mental" class="tab-panel" aria-label="Mental">
                        <div class="tab-panel-header">
                            <h2 class="section-title section-title--inline">Mental</h2>
                            <button type="button" class="save-tab-button" data-tab="mental">Sauvegarder</button>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="mentalCaractere">Caract√®re</label>
                            <textarea
                                id="mentalCaractere"
                                class="field-input field-textarea"
                                rows="5"
                                placeholder="5 lignes minimum : temp√©rament, r√©actions, qualit√©s, d√©fauts, √©volution possible."
                            ></textarea>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="mentalButsReves">But(s) &amp; r√™ve(s)</label>
                            <textarea
                                id="mentalButsReves"
                                class="field-input field-textarea"
                                rows="4"
                                placeholder="Au moins un but et un r√™ve obligatoires (objectifs de vie, aspirations profondes)."
                            ></textarea>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="mentalAutre">Autre</label>
                            <textarea
                                id="mentalAutre"
                                class="field-input field-textarea"
                                rows="3"
                                placeholder="Particularit√©s du comportement, phobies, TOC, habitudes, etc."
                            ></textarea>
                        </div>
                    </section>

                    <!-- Physique -->
                    <section id="tab-physique" class="tab-panel" aria-label="Physique">
                        <div class="tab-panel-header">
                            <h2 class="section-title section-title--inline">Physique</h2>
                            <button type="button" class="save-tab-button" data-tab="physique">Sauvegarder</button>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="physiqueDescription">Description physique</label>
                            <textarea
                                id="physiqueDescription"
                                class="field-input field-textarea"
                                rows="3"
                                placeholder="3 lignes minimum : allure, tenues, d√©tails marquants (cicatrices, bijoux, etc.)."
                            ></textarea>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="physiqueSante">Sant√©</label>
                            <textarea
                                id="physiqueSante"
                                class="field-input field-textarea"
                                rows="3"
                                placeholder="Pr√©cisez les √©ventuels probl√®mes de sant√©, limitations ou particularit√©s."
                            ></textarea>
                        </div>
                    </section>

                    <!-- Background -->
                    <section id="tab-background" class="tab-panel" aria-label="Background">
                        <div class="tab-panel-header">
                            <h2 class="section-title section-title--inline">Background</h2>
                            <button type="button" class="save-tab-button" data-tab="background">Sauvegarder</button>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="backgroundFamille">Parents / famille</label>
                            <textarea
                                id="backgroundFamille"
                                class="field-input field-textarea"
                                rows="4"
                                placeholder="Famille proche, liens importants, √©ventuels liens nobles ou religieux."
                            ></textarea>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="backgroundHistoire">Histoire</label>
                            <textarea
                                id="backgroundHistoire"
                                class="field-input field-textarea"
                                rows="10"
                                placeholder="Minimum ~2000 caract√®res (avec espaces). Racontez le parcours complet du personnage, les √©v√©nements marquants, sa place dans le monde."
                            ></textarea>
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="backgroundImage1">Image 1 (URL)</label>
                            <input
                                id="backgroundImage1"
                                class="field-input"
                                type="url"
                                placeholder="Lien vers une r√©f√©rence visuelle du personnage."
                            >
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="backgroundImage2">Image 2 (URL)</label>
                            <input
                                id="backgroundImage2"
                                class="field-input"
                                type="url"
                                placeholder="Deuxi√®me lien d'image (optionnel)."
                            >
                        </div>

                        <div class="field-group">
                            <label class="field-label" for="backgroundImage3">Image 3 (URL)</label>
                            <input
                                id="backgroundImage3"
                                class="field-input"
                                type="url"
                                placeholder="Troisi√®me lien d'image (optionnel)."
                            >
                        </div>
                    </section>
                </form>
            </section>
        </section>
    </main>

    <script type="module" src="js/ui/app-shell.js"></script>
    <script>
        (async function () {
            const tabButtons = Array.from(document.querySelectorAll('.tab-button'));
            const tabPanels = Array.from(document.querySelectorAll('.tab-panel'));
            const saveButtons = Array.from(document.querySelectorAll('.save-tab-button'));
            const dirtyTabs = new Set();
            const CHARACTER_STORAGE_KEY = 'astoria_active_character';
            const LEGACY_SUMMARY_KEY = 'astoria_character_summary';
            const STORAGE_PREFIX = 'fiche';
            let currentCharacterKey = 'default';
            let summaryModule = null;
            let summaryElements = null;
            const relationsContainer = document.getElementById('backgroundRelations');
            const addRelationBtn = document.getElementById('addBackgroundRelation');
            const RELATION_TYPES = [
                { value: 'family', label: 'Famille' },
                { value: 'friend', label: 'Ami' },
                { value: 'enemy', label: 'Ennemi' },
                { value: 'rival', label: 'Rival' },
                { value: 'romance', label: 'Romantique' },
                { value: 'mentor', label: 'Mentor' },
                { value: 'ally', label: 'Allie' }
            ];
            let authApi = null;
            try {
                authApi = await import('./js/auth.js');
            } catch (error) {
                authApi = null;
            }

            try {
                summaryModule = await import('./js/ui/character-summary.js');
            } catch (error) {
                summaryModule = null;
            }
            const summaryState = await summaryModule?.initCharacterSummary({ includeQueryParam: true, enableDropdown: true }) || null;
            summaryElements = summaryState?.elements || null;
            currentCharacterKey = summaryState?.context?.key || currentCharacterKey;

            function updateRelationLink(row) {
                const input = row.querySelector('.relation-character');
                const link = row.querySelector('.relation-link-btn');
                if (!input || !link) return;
                const value = input.value.trim();
                if (!value) {
                    link.hidden = true;
                    link.removeAttribute('href');
                    return;
                }
                link.hidden = false;
                link.href = `profil.html?character=${encodeURIComponent(value)}`;
            }

            function createRelationRow(data) {
                const row = document.createElement('div');
                row.className = 'relation-row';

                const nameInput = document.createElement('input');
                nameInput.className = 'field-input relation-name';
                nameInput.type = 'text';
                nameInput.placeholder = 'Nom du lien';

                const typeSelect = document.createElement('select');
                typeSelect.className = 'field-input relation-type';
                RELATION_TYPES.forEach((optionData) => {
                    const option = document.createElement('option');
                    option.value = optionData.value;
                    option.textContent = optionData.label;
                    typeSelect.appendChild(option);
                });

                const charInput = document.createElement('input');
                charInput.className = 'field-input relation-character';
                charInput.type = 'text';
                charInput.placeholder = 'ID personnage (optionnel)';

                const link = document.createElement('a');
                link.className = 'relation-link-btn';
                link.textContent = 'Voir profil';
                link.target = '_blank';
                link.rel = 'noopener';
                link.hidden = true;

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'relation-remove-btn';
                removeBtn.textContent = 'Retirer';

                row.append(nameInput, typeSelect, charInput, link, removeBtn);

                if (data) {
                    if (data.name) nameInput.value = data.name;
                    if (data.type) typeSelect.value = data.type;
                    if (data.characterId) charInput.value = data.characterId;
                }

                updateRelationLink(row);

                const markDirty = () => markTabDirty('background');
                nameInput.addEventListener('input', markDirty);
                typeSelect.addEventListener('change', markDirty);
                charInput.addEventListener('input', () => {
                    updateRelationLink(row);
                    markDirty();
                });

                removeBtn.addEventListener('click', () => {
                    row.remove();
                    markDirty();
                });

                return row;
            }

            function collectRelations() {
                if (!relationsContainer) return [];
                const rows = Array.from(relationsContainer.querySelectorAll('.relation-row'));
                return rows
                    .map((row) => {
                        const name = row.querySelector('.relation-name')?.value.trim() || '';
                        const type = row.querySelector('.relation-type')?.value || '';
                        const characterId = row.querySelector('.relation-character')?.value.trim() || '';
                        if (!name && !type && !characterId) return null;
                        return { name, type, characterId };
                    })
                    .filter(Boolean);
            }

            function restoreRelations(relations) {
                if (!relationsContainer) return;
                relationsContainer.innerHTML = '';
                (relations || []).forEach((relation) => {
                    relationsContainer.appendChild(createRelationRow(relation));
                });
            }

            function getInputValue(id) {
                const input = document.getElementById(id);
                return input ? input.value.trim() : '';
            }

            function getSelectLabel(id) {
                const select = document.getElementById(id);
                if (!select) return '';
                if (!select.value) return '';
                const option = select.options[select.selectedIndex];
                return option ? option.textContent.trim() : '';
            }

            function syncProfileFromFiche() {
                const active = summaryModule?.getActiveCharacterFromStorage
                    ? summaryModule.getActiveCharacterFromStorage()
                    : null;
                const name = getInputValue('identiteNomPrenom');
                const race = getInputValue('identiteRace');
                const roleLabel = getSelectLabel('appRole');
                const profileData = active?.profile_data || {};
                const avatarUrl = profileData.avatar_url || '';
                const roleText = [race, roleLabel].filter(Boolean).join(' - ');
                const summary = {
                    id: active?.id || null,
                    name: name || active?.name || 'Personnage',
                    role: roleText || 'Classe / Role / Surnom',
                    avatar_url: avatarUrl
                };

                if (summary.id) {
                    try {
                        localStorage.setItem(LEGACY_SUMMARY_KEY, JSON.stringify(summary));
                    } catch {}
                }

                if (active && active.id) {
                    const next = { ...active };
                    if (name) next.name = name;
                    if (race) next.race = race;
                    if (roleLabel) next.class = roleLabel;
                    next.profile_data = { ...profileData, fiche_summary: summary };
                    try {
                        localStorage.setItem(CHARACTER_STORAGE_KEY, JSON.stringify(next));
                    } catch {}
                }

                if (summaryModule?.applySummaryToElements) {
                    summaryModule.applySummaryToElements(summaryElements, summary);
                }

                if (authApi?.updateCharacter && active?.id) {
                    const updates = {
                        profile_data: { ...profileData, fiche_summary: summary }
                    };
                    if (name) updates.name = name;
                    if (race) updates.race = race;
                    if (roleLabel) updates.class = roleLabel;
                    authApi.updateCharacter(active.id, updates).catch(() => {});
                }
            }

            function getTabStorageKey(tabName) {
                return `${STORAGE_PREFIX}-${currentCharacterKey}-${tabName}`;
            }

            function getLegacyTabStorageKey(tabName) {
                return `${STORAGE_PREFIX}-${tabName}`;
            }

            function clearAllDirty() {
                dirtyTabs.clear();
                saveButtons.forEach((btn) => btn.classList.remove('save-button--highlight'));
            }

            // Tab switching
            tabButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const target = button.dataset.tab;
                    if (!target) return;

                    tabButtons.forEach((btn) => btn.classList.remove('active'));
                    button.classList.add('active');

                    tabPanels.forEach((panel) => {
                        const isActive = panel.id === 'tab-' + target;
                        panel.classList.toggle('active', isActive);
                        panel.hidden = !isActive;
                    });
                });
            });

            // Alice checkboxes visibility
            const hasAliceCheckbox = document.getElementById('hasAlice');
            const hasDoubleAliceCheckbox = document.getElementById('hasDoubleAlice');
            const aliceContainer = document.getElementById('alice-container');
            const alice2Fields = document.getElementById('alice2-fields');

            const updateAliceVisibility = () => {
                const hasAlice = hasAliceCheckbox.checked;
                const hasDoubleAlice = hasDoubleAliceCheckbox.checked;

                aliceContainer.style.display = hasAlice ? 'grid' : 'none';
                alice2Fields.style.display = hasDoubleAlice ? 'block' : 'none';
            };

            hasAliceCheckbox.addEventListener('change', updateAliceVisibility);
            hasDoubleAliceCheckbox.addEventListener('change', updateAliceVisibility);

            // Other conditional visibility
            const conditionalConfigs = [
                { checkboxId: 'hasMagic', panelId: 'sorcellerie-fields' },
                { checkboxId: 'hasEater', panelId: 'eater-fields' }
            ];

            conditionalConfigs.forEach(({ checkboxId, panelId }) => {
                const checkbox = document.getElementById(checkboxId);
                const panel = document.getElementById(panelId);
                if (!checkbox || !panel) return;

                checkbox.addEventListener('change', updateConditionalVisibility);
            });

            function updateConditionalVisibility() {
                conditionalConfigs.forEach(({ checkboxId, panelId }) => {
                    const checkbox = document.getElementById(checkboxId);
                    const panel = document.getElementById(panelId);
                    if (!checkbox || !panel) return;
                    panel.hidden = !checkbox.checked;
                });
            }

            updateConditionalVisibility();

            // Dynamic Magie Suppl√©mentaire
            const addMagieBtn = document.getElementById('addMagieSupplementaire');
            const magieContainer = document.getElementById('magie-supplementaire-container');
            let magieSupCount = 0;

            addMagieBtn.addEventListener('click', () => {
                magieSupCount++;
                const fieldGroup = document.createElement('div');
                fieldGroup.className = 'field-group';
                fieldGroup.innerHTML = `
                    <label class="field-label" for="magieSup${magieSupCount}">Magie suppl√©mentaire</label>
                    <div class="magie-sup-row">
                        <input
                            id="magieSup${magieSupCount}"
                            class="field-input magie-supplementaire"
                            type="text"
                            placeholder="Magie suppl√©mentaire..."
                        >
                        <button type="button" class="remove-magie-btn">√ó</button>
                    </div>
                `;
                magieContainer.appendChild(fieldGroup);

                // Remove button handler
                fieldGroup.querySelector('.remove-magie-btn').addEventListener('click', () => {
                    fieldGroup.remove();
                    markTabDirty('sorcellerie');
                });

                markTabDirty('sorcellerie');
            });

            if (addRelationBtn) {
                addRelationBtn.addEventListener('click', () => {
                    if (!relationsContainer) return;
                    relationsContainer.appendChild(createRelationRow());
                    markTabDirty('background');
                });
            }

            // Mark tab as dirty when any input changes
            function markTabDirty(tabName) {
                dirtyTabs.add(tabName);
                const saveBtn = document.querySelector(`.save-tab-button[data-tab="${tabName}"]`);
                if (saveBtn) {
                    saveBtn.classList.add('save-button--highlight');
                }
            }

            function clearTabDirty(tabName) {
                dirtyTabs.delete(tabName);
                const saveBtn = document.querySelector(`.save-tab-button[data-tab="${tabName}"]`);
                if (saveBtn) {
                    saveBtn.classList.remove('save-button--highlight');
                }
            }

            function resetTab(tabName) {
                const panel = document.getElementById('tab-' + tabName);
                if (!panel) return;

                const inputs = panel.querySelectorAll('input, select, textarea');
                inputs.forEach((input) => {
                    if (input.classList.contains('magie-supplementaire')) return;
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else if (input.tagName === 'SELECT') {
                        input.selectedIndex = 0;
                    } else {
                        input.value = '';
                    }
                });

                if (tabName === 'sorcellerie' && magieContainer) {
                    const extraInputs = magieContainer.querySelectorAll('.magie-supplementaire');
                    extraInputs.forEach((input) => {
                        const group = input.closest('.field-group');
                        if (group) group.remove();
                    });
                    magieSupCount = 0;
                }
                if (tabName === 'background' && relationsContainer) {
                    relationsContainer.innerHTML = '';
                }
            }

            // Add change listeners to all inputs
            tabPanels.forEach((panel) => {
                const tabName = panel.id.replace('tab-', '');
                const inputs = panel.querySelectorAll('input, select, textarea');

                inputs.forEach((input) => {
                    input.addEventListener('input', () => markTabDirty(tabName));
                    input.addEventListener('change', () => markTabDirty(tabName));
                });
            });

            // Save button functionality
            saveButtons.forEach((btn) => {
                btn.addEventListener('click', () => {
                    const tabName = btn.dataset.tab;
                    saveTab(tabName);
                    clearTabDirty(tabName);
                });
            });

            function saveTab(tabName) {
                const panel = document.getElementById('tab-' + tabName);
                if (!panel) return;

                const data = {};
                const inputs = panel.querySelectorAll('input, select, textarea');

                inputs.forEach((input) => {
                    if (input.type === 'checkbox') {
                        data[input.id] = input.checked;
                    } else {
                        data[input.id] = input.value;
                    }
                });

                // Save dynamic magie supplementaire
                if (tabName === 'sorcellerie') {
                    const magieSupInputs = panel.querySelectorAll('.magie-supplementaire');
                    data.magieSupplementaire = Array.from(magieSupInputs).map(input => input.value);
                }
                if (tabName === 'background') {
                    data.backgroundRelations = collectRelations();
                }

                localStorage.setItem(getTabStorageKey(tabName), JSON.stringify(data));
                console.log('Saved tab:', tabName, data);

                if (tabName === 'identite' || tabName === 'appartenance') {
                    syncProfileFromFiche();
                }

                // Visual feedback
                btn.textContent = 'Sauvegard√© ‚úì';
                setTimeout(() => {
                    btn.textContent = 'Sauvegarder';
                }, 2000);
            }

            function loadTab(tabName) {
                const panel = document.getElementById('tab-' + tabName);
                if (!panel) return;

                const storageKey = getTabStorageKey(tabName);
                let savedData = localStorage.getItem(storageKey);
                if (!savedData) {
                    const legacyKey = getLegacyTabStorageKey(tabName);
                    const legacyData = localStorage.getItem(legacyKey);
                    if (legacyData) {
                        savedData = legacyData;
                        localStorage.setItem(storageKey, legacyData);
                    }
                }
                resetTab(tabName);
                if (!savedData) return;

                const data = JSON.parse(savedData);

                Object.keys(data).forEach((key) => {
                    if (key === 'magieSupplementaire') return; // Handle separately

                    const input = document.getElementById(key);
                    if (!input) return;

                    if (input.type === 'checkbox') {
                        input.checked = data[key];
                    } else {
                        input.value = data[key];
                    }
                });

                // Restore dynamic magie supplementaire
                if (tabName === 'sorcellerie' && data.magieSupplementaire) {
                    data.magieSupplementaire.forEach((value) => {
                        if (!value) return;
                        magieSupCount++;
                        const fieldGroup = document.createElement('div');
                        fieldGroup.className = 'field-group';
                        fieldGroup.innerHTML = `
                            <label class="field-label" for="magieSup${magieSupCount}">Magie suppl√©mentaire</label>
                            <div class="magie-sup-row">
                                <input
                                    id="magieSup${magieSupCount}"
                                    class="field-input magie-supplementaire"
                                    type="text"
                                    value="${value}"
                                    placeholder="Magie suppl√©mentaire..."
                                >
                                <button type="button" class="remove-magie-btn">√ó</button>
                            </div>
                        `;
                        magieContainer.appendChild(fieldGroup);

                        fieldGroup.querySelector('.remove-magie-btn').addEventListener('click', () => {
                            fieldGroup.remove();
                            markTabDirty('sorcellerie');
                        });
                    });
                }

                // Trigger visibility updates
                if (tabName === 'alice') {
                    updateAliceVisibility();
                }
                if (tabName === 'background') {
                    restoreRelations(data.backgroundRelations || []);
                }
                updateConditionalVisibility();
            }

            // Load all tabs on page load
            const allTabs = ['identite', 'appartenance', 'combat', 'alice', 'sorcellerie', 'eater', 'religion', 'mental', 'physique', 'background'];

            function loadAllTabs() {
                allTabs.forEach(loadTab);
                updateAliceVisibility();
                updateConditionalVisibility();
            }

            const initialContext = summaryModule?.resolveCharacterContext
                ? summaryModule.resolveCharacterContext({ includeQueryParam: true })
                : { key: currentCharacterKey, character: null };
            currentCharacterKey = initialContext.key || currentCharacterKey;
            if (summaryModule?.applySummaryToElements && summaryModule?.buildSummary) {
                summaryModule.applySummaryToElements(summaryElements, summaryModule.buildSummary(initialContext));
            }
            loadAllTabs();

            setInterval(() => {
                if (!summaryModule?.resolveCharacterContext || !summaryModule?.buildSummary) return;
                const nextContext = summaryModule.resolveCharacterContext({ includeQueryParam: true });
                summaryModule.applySummaryToElements(summaryElements, summaryModule.buildSummary(nextContext));
                if (nextContext.key !== currentCharacterKey) {
                    currentCharacterKey = nextContext.key;
                    clearAllDirty();
                    loadAllTabs();
                }
            }, 800);
        })();
    </script>
</body>
</html>
