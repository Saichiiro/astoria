<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic localStorage - Astoria</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            background: #f5f5f5;
        }
        .panel {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #d81b60;
            margin-top: 0;
        }
        h2 {
            color: #333;
            font-size: 1.1rem;
            margin-top: 0;
        }
        .key {
            font-weight: 600;
            color: #555;
        }
        .value {
            font-family: 'Courier New', monospace;
            background: #f0f0f0;
            padding: 0.5rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        .ok {
            color: #2e7d32;
            font-weight: 600;
        }
        .error {
            color: #c62828;
            font-weight: 600;
        }
        .warning {
            color: #f57c00;
            font-weight: 600;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        button {
            background: #d81b60;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        button:hover {
            background: #ad1457;
        }
    
        </style>
<style type="text/tailwindcss">@layer utilities {
            .fade-in {
                @apply opacity-0 translate-y-2;
                animation: fadeIn 0.6s ease forwards;
            }
        }
        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

                        @layer components {
            .tw-surface { @apply shadow-soft ring-1 ring-black/5; }
            .tw-surface-strong { @apply shadow-soft ring-2 ring-astoria-200/60; }
            .tw-press { @apply transition-transform duration-200 ease-out active:scale-[0.98]; }
            .tw-hover { @apply transition-transform duration-200 ease-out hover:-translate-y-0.5; }
            .tw-panel { @apply rounded-2xl bg-white/80 backdrop-blur-md border border-white/70 shadow-soft; }
            .tw-card { @apply rounded-2xl bg-white/90 border border-astoria-200/60 shadow-soft; }
            .tw-card-hover { @apply transition-transform duration-200 ease-out hover:-translate-y-1; }
            .tw-btn { @apply inline-flex items-center justify-center gap-2 rounded-full px-4 py-2 font-semibold shadow-soft bg-gradient-to-br from-astoria-400 to-astoria-600 text-white; }
            .tw-btn-ghost { @apply rounded-full border border-astoria-200/70 bg-white/80 text-astoria-600; }
            .tw-input { @apply rounded-xl border border-astoria-200/60 bg-white/90 px-4 py-2 text-sm font-semibold text-gray-700 focus:ring-2 focus:ring-astoria-400/40; }
            .tw-pill { @apply inline-flex items-center gap-1 rounded-full bg-white/70 border border-astoria-200/60 px-3 py-1 text-xs font-semibold text-astoria-600; }
            .tw-back { @apply inline-flex items-center gap-2 rounded-full border border-astoria-200/70 bg-white/80 text-astoria-600 px-4 py-2 font-semibold shadow-soft; }
        }
</style>
    <script src="js/tailwind-config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        @layer base {
            html { @apply scroll-smooth; }
            body { @apply antialiased; }
            a, button, [role="button"] { @apply transition-colors duration-200 ease-out; }
            input, select, textarea { @apply transition-shadow duration-200 ease-out; }
            a:focus-visible, button:focus-visible, [role="button"]:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible { @apply outline-none ring-2 ring-astoria-400 ring-offset-2 ring-offset-white; }
        }
    </style>
</head>
<body class="min-h-screen">
    <h1>üîç Diagnostic localStorage - Astoria</h1>
    <div class="panel tw-surface">
        <h2>1. Informations Page</h2>
        <div class="key">URL :</div>
        <div class="value" id="pageUrl"></div>
        <div class="key">Origin :</div>
        <div class="value" id="pageOrigin"></div>
        <div class="key">Protocol :</div>
        <div class="value" id="pageProtocol"></div>
    </div>
    <div class="panel tw-surface">
        <h2>2. localStorage.getItem('astoria_session')</h2>
        <div id="sessionCheck"></div>
    </div>
    <div class="panel tw-surface">
        <h2>3. localStorage.getItem('astoria_active_character')</h2>
        <div id="characterCheck"></div>
    </div>
    <div class="panel tw-surface">
        <h2>4. Test import modules</h2>
        <div id="moduleCheck"></div>
    </div>
    <div class="panel tw-surface">
        <h2>5. Tout le localStorage</h2>
        <div id="allStorage"></div>
    </div>
    <div class="panel tw-surface">
        <h2>Actions</h2>
        <button onclick="window.location.href='index.html'" class="tw-press">Aller √† index.html</button>
        <button onclick="window.location.href='hdv.html'" class="tw-press">Aller √† hdv.html</button>
        <button onclick="window.location.href='profil.html'" class="tw-press">Aller √† profil.html</button>
        <button onclick="window.location.reload()" class="tw-press">Recharger</button>
    </div>
    <script type="module">
        // 1. Page info
        document.getElementById('pageUrl').textContent = window.location.href;
        document.getElementById('pageOrigin').textContent = window.location.origin;
        document.getElementById('pageProtocol').textContent = window.location.protocol;
        // 2. Session check
        const sessionRaw = localStorage.getItem('astoria_session');
        const sessionEl = document.getElementById('sessionCheck');
        if (!sessionRaw) {
            sessionEl.innerHTML = '<div class="error">‚ùå NULL - Pas de session trouv√©e !</div>';
        } else {
            try {
                const sessionData = JSON.parse(sessionRaw);
                const hasUser = sessionData && sessionData.user && sessionData.user.id;
                if (hasUser) {
                    sessionEl.innerHTML = `
                        <div class="ok">‚úÖ Session valide</div>
                        <div class="key">Username :</div>
                        <div class="value">${sessionData.user.username || 'N/A'}</div>
                        <div class="key">User ID :</div>
                        <div class="value">${sessionData.user.id || 'N/A'}</div>
                        <div class="key">Timestamp :</div>
                        <div class="value">${new Date(sessionData.timestamp).toLocaleString()}</div>
                        <div class="key">JSON complet :</div>
                        <div class="value"><pre>${JSON.stringify(sessionData, null, 2)}</pre></div>
                    `;
                } else {
                    sessionEl.innerHTML = `
                        <div class="warning">‚ö†Ô∏è Session existe mais pas de user</div>
                        <div class="value"><pre>${JSON.stringify(sessionData, null, 2)}</pre></div>
                    `;
                }
            } catch (err) {
                sessionEl.innerHTML = `
                    <div class="error">‚ùå JSON invalide</div>
                    <div class="value"><pre>${sessionRaw}</pre></div>
                    <div class="error">${err.message}</div>
                `;
            }
        }
        // 3. Character check
        const charRaw = localStorage.getItem('astoria_active_character');
        const charEl = document.getElementById('characterCheck');
        if (!charRaw) {
            charEl.innerHTML = '<div class="warning">‚ö†Ô∏è NULL - Aucun personnage actif</div>';
        } else {
            try {
                const charData = JSON.parse(charRaw);
                const hasId = charData && charData.id;
                if (hasId) {
                    charEl.innerHTML = `
                        <div class="ok">‚úÖ Personnage actif trouv√©</div>
                        <div class="key">Nom :</div>
                        <div class="value">${charData.name || 'N/A'}</div>
                        <div class="key">ID :</div>
                        <div class="value">${charData.id || 'N/A'}</div>
                        <div class="key">JSON complet :</div>
                        <div class="value"><pre>${JSON.stringify(charData, null, 2)}</pre></div>
                    `;
                } else {
                    charEl.innerHTML = `
                        <div class="warning">‚ö†Ô∏è Existe mais pas d'ID</div>
                        <div class="value"><pre>${JSON.stringify(charData, null, 2)}</pre></div>
                    `;
                }
            } catch (err) {
                charEl.innerHTML = `
                    <div class="error">‚ùå JSON invalide</div>
                    <div class="value"><pre>${charRaw}</pre></div>
                    <div class="error">${err.message}</div>
                `;
            }
        }
        // 4. Module test
        const moduleEl = document.getElementById('moduleCheck');
        moduleEl.innerHTML = '<div>Chargement des modules...</div>';
        try {
            const authModule = await import('./js/auth.js');
            const { getCurrentUser, getActiveCharacter } = authModule;
            const currentUser = getCurrentUser ? getCurrentUser() : null;
            const activeChar = getActiveCharacter ? getActiveCharacter() : null;
            let html = '<div class="ok">‚úÖ Import r√©ussi</div>';
            if (currentUser && currentUser.id) {
                html += `
                    <div class="ok">‚úÖ getCurrentUser() retourne un user</div>
                    <div class="key">Username :</div>
                    <div class="value">${currentUser.username || 'N/A'}</div>
                `;
            } else {
                html += '<div class="error">‚ùå getCurrentUser() retourne NULL</div>';
            }
            if (activeChar && activeChar.id) {
                html += `
                    <div class="ok">‚úÖ getActiveCharacter() retourne un personnage</div>
                    <div class="key">Nom :</div>
                    <div class="value">${activeChar.name || 'N/A'}</div>
                `;
            } else {
                html += '<div class="warning">‚ö†Ô∏è getActiveCharacter() retourne NULL</div>';
            }
            moduleEl.innerHTML = html;
        } catch (err) {
            moduleEl.innerHTML = `
                <div class="error">‚ùå Erreur import module</div>
                <div class="error">${err.message}</div>
                <div class="value"><pre>${err.stack}</pre></div>
            `;
        }
        // 5. All storage
        const allEl = document.getElementById('allStorage');
        const allKeys = Object.keys(localStorage).filter(k => k.startsWith('astoria'));
        if (allKeys.length === 0) {
            allEl.innerHTML = '<div class="error">‚ùå Aucune cl√© Astoria dans localStorage</div>';
        } else {
            let html = `<div class="ok">‚úÖ ${allKeys.length} cl√©(s) trouv√©e(s)</div>`;
            allKeys.forEach(key => {
                const value = localStorage.getItem(key);
                const truncated = value && value.length > 200 ? value.substring(0, 200) + '...' : value;
                html += `
                    <div class="key" style="margin-top: 1rem;">${key} :</div>
                    <div class="value"><pre>${truncated}</pre></div>
                `;
            });
            allEl.innerHTML = html;
        }
    </script>
    <script src="js/sidebar.js"></script>
</body>
</html>
