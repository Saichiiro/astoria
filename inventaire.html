<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaire - Astoria</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Main inventory wrapper -->
    <div class="inventory-wrapper">
        <!-- Header with title and back button -->
        <div class="inventory-header">
            <a href="index.html" class="back-link" title="Retour √† la liste">‚Üê</a>
            <h1 class="inventory-title">Inventaire</h1>
            <div class="inventory-actions">
                <span id="itemCount" class="inventory-info">0 objets</span>
                <button class="add-item-btn" id="openAddPanel" title="Ajouter un objet">
                    <span class="add-icon">+</span>
                    <span class="add-label">Ajouter</span>
                </button>
            </div>
        </div>

        <!-- Category filter bar -->
        <div class="inventory-categories">
            <button class="category-btn active" data-category="all">
                <span class="category-icon">üì¶</span>
                <span class="category-label">Tous</span>
            </button>
            <button class="category-btn" data-category="equipement">
                <span class="category-icon">‚öîÔ∏è</span>
                <span class="category-label">√âquipements</span>
            </button>
            <button class="category-btn" data-category="consommable">
                <span class="category-icon">üß™</span>
                <span class="category-label">Consommables</span>
            </button>
            <button class="category-btn" data-category="agricole">
                <span class="category-icon">üåæ</span>
                <span class="category-label">Agricole</span>
            </button>
        </div>

        <!-- Main content area: grid + details -->
        <div class="inventory-content">
            <!-- Items grid (left side) -->
            <div class="inventory-grid-container">
                <div class="inventory-grid" id="inventoryGrid">
                    <!-- Items will be rendered here by JS -->
                </div>
                <div class="empty-inventory" id="emptyState" style="display: none;">
                    <div class="empty-state-icon">üì¶</div>
                    <div class="empty-state-title">Aucun objet</div>
                    <div class="empty-state-message">Votre inventaire est vide dans cette cat√©gorie</div>
                </div>
            </div>

            <!-- Item detail panel (right side) -->
            <div class="inventory-detail" id="itemDetail">
                <div class="detail-placeholder">
                    <div class="placeholder-icon">üëÜ</div>
                    <p>S√©lectionnez un objet pour voir ses d√©tails</p>
                </div>
                <!-- Details will be rendered here when item is selected -->
            </div>
        </div>
    </div>

    <!-- Add item panel (slide-in from right) -->
    <div class="add-panel" id="addPanel">
        <div class="add-panel-inner">
            <div class="add-panel-header">
                <h2>Ajouter un objet</h2>
                <button class="panel-close-btn" id="closeAddPanel">&times;</button>
            </div>

            <div class="add-panel-body">
                <!-- Item selector (from existing database) -->
                <div class="form-group">
                    <label for="itemSelect">Objet *</label>
                    <select id="itemSelect" required>
                        <option value="">-- S√©lectionner un objet --</option>
                        <!-- Options populated by JS from inventoryData -->
                    </select>
                </div>

                <!-- Category selector -->
                <div class="form-group">
                    <label for="categorySelect">Cat√©gorie *</label>
                    <select id="categorySelect" required>
                        <option value="all">üì¶ Toutes cat√©gories</option>
                        <option value="equipement">‚öîÔ∏è √âquipement</option>
                        <option value="consommable">üß™ Consommable</option>
                        <option value="agricole">üåæ Agricole</option>
                    </select>
                </div>

                <!-- Quantity selector -->
                <div class="form-group">
                    <label for="quantityInput">Quantit√© *</label>
                    <div class="quantity-control">
                        <button type="button" class="qty-btn" id="qtyMinus">‚àí</button>
                        <input type="number" id="quantityInput" min="1" value="1">
                        <button type="button" class="qty-btn" id="qtyPlus">+</button>
                    </div>
                </div>

                <!-- Item preview (shows selected item details) -->
                <div id="itemPreview" style="display: none;">
                    <div class="form-group">
                        <label>Aper√ßu</label>
                        <div class="item-preview-card">
                            <img id="previewImage" src="" alt="" style="width: 80px; height: 80px; object-fit: contain;">
                            <div>
                                <div style="font-weight: 600;" id="previewName"></div>
                                <div style="font-size: 14px; color: #666;" id="previewDescription"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="add-panel-footer">
                <button type="button" class="btn-secondary" id="cancelAdd">Annuler</button>
                <button type="button" class="btn-primary" id="confirmAdd">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Load shared data -->
    <script src="data.js"></script>

    <!-- Inventory-specific JS -->
    <script>
        /**
         * ========================================================================
         * INVENTORY MODULE - EMPTY BY DEFAULT WITH ADD PANEL
         * ========================================================================
         *
         * TEMPORARY IMPLEMENTATION FOR TESTING:
         * - Inventory starts EMPTY on first load
         * - Items stored in localStorage for persistence (testing only)
         * - Items are added via "+" panel which selects from existing database
         * - All item data (name, description, image) comes from data.js
         *
         * FUTURE INTEGRATION:
         * - Replace localStorage with real backend API
         * - Load inventory from server instead of localStorage
         * - Connect to global item management system
         * ========================================================================
         */

        // =================================================================
        // CONFIGURATION
        // =================================================================

        /**
         * IMAGE CONFIGURATION
         * Maps item names/keys to actual image paths from our existing dataset
         */
        const IMAGE_CONFIG = {
            basePath: 'assets/images/',
            // Map item name (normalized) to filename
            mappings: {
                'poudrededetracage': 'Poudre_de_Tracage.png',
                'poudredetracage': 'Poudre_de_Tracage.png',
                'larmedematera': 'Larme_de_Matera.png',
                'fruitpapooru': 'Fruit_Papooru.jpg',
                'fioledevitalite': 'Fiole_de_vitalite.jpg',
                'parchemindeveil': 'Parchemin_Eveil.jpg',
                'parcheminascension': 'Parchemin_Ascension.jpg',
                'clefmanndorf': 'Clef_Manndorf.png',
                'armuredevexarion': 'Armure_de_Vexarion.png',
                'sceptredekrythus': 'Sceptre_de_Krythus.png',
                'capedelaubevermeille': 'Cape_de_lAube_Vermeille_off.jpg',
                'bookofaeris': 'Book_of_Aeris.png',
                'thequeenspoison': 'The_Queens_Poison.png',
                'clochederesonnance': 'Cloche_de_Resonnance.png',
                'veillenuit': 'VeilleNuit.png'
            }
        };

        /**
         * PLACEHOLDER IMAGE (SVG)
         * Shown when no image or image fails to load
         */
        const PLACEHOLDER_IMAGE =
            "data:image/svg+xml;utf8," +
            encodeURIComponent(
                `<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'>` +
                `<rect width='80' height='80' fill='#f0f0f0'/>` +
                `<text x='50%' y='50%' text-anchor='middle' dy='0.3em' fill='#d81b60' font-family='Arial' font-size='14'>?</text>` +
                `</svg>`
            );

        // =================================================================
        // STATE
        // =================================================================

        let currentCategory = 'all';
        let selectedItemIndex = null;
        let inventoryItems = []; // Starts EMPTY
        let nextItemId = 1; // Auto-increment ID for new items

        // =================================================================
        // DOM REFERENCES
        // =================================================================

        const grid = document.getElementById('inventoryGrid');
        const detailPanel = document.getElementById('itemDetail');
        const emptyState = document.getElementById('emptyState');
        const itemCountEl = document.getElementById('itemCount');
        const categoryButtons = document.querySelectorAll('.category-btn');

        // Add panel elements
        const addPanel = document.getElementById('addPanel');
        const openAddBtn = document.getElementById('openAddPanel');
        const closeAddBtn = document.getElementById('closeAddPanel');
        const cancelAddBtn = document.getElementById('cancelAdd');
        const confirmAddBtn = document.getElementById('confirmAdd');
        const itemSelect = document.getElementById('itemSelect');
        const categorySelect = document.getElementById('categorySelect');
        const quantityInput = document.getElementById('quantityInput');
        const qtyMinusBtn = document.getElementById('qtyMinus');
        const qtyPlusBtn = document.getElementById('qtyPlus');
        const itemPreview = document.getElementById('itemPreview');
        const previewImage = document.getElementById('previewImage');
        const previewName = document.getElementById('previewName');
        const previewDescription = document.getElementById('previewDescription');

        // =================================================================
        // INITIALIZATION
        // =================================================================

        /**
         * Initialize inventory - EMPTY BY DEFAULT
         * - Loads from localStorage ONLY (if present)
         * - Otherwise displays empty inventory
         * - Renders the UI
         */
        function initInventory() {
            console.log('Initializing inventory...');

            // TEMPORARY: Load from localStorage for testing
            // FUTURE: Replace with API call to load user's inventory
            loadFromLocalStorage();

            // Render
            renderInventory();

            // Note: Item selector is populated when add panel opens
        }

        // =================================================================
        // ITEM DATABASE ACCESS
        // =================================================================

        /**
         * TEMPORARY FUNCTION: Get all available items from data.js
         *
         * This function accesses our existing central item database (inventoryData).
         * In production, this would query the real backend database.
         *
         * @returns {Array} All available items from the game database
         */
        function getAllItems() {
            if (typeof inventoryData === 'undefined' || !inventoryData) {
                console.warn('inventoryData not found in data.js');
                return [];
            }
            return inventoryData;
        }

        /**
         * Populate the item selector dropdown with items from database
         * Filters by selected category for clarity
         */
        function populateItemSelector() {
            const allItems = getAllItems();
            const selectedCategory = categorySelect.value;

            // Clear existing options (except the first placeholder)
            itemSelect.innerHTML = '<option value="">-- S√©lectionner un objet --</option>';

            // Filter items by category if not "all"
            const filteredItems = selectedCategory === 'all'
                ? allItems
                : allItems.filter(item => item.category === selectedCategory);

            // Add filtered items as options
            filteredItems.forEach((item, index) => {
                // Use the original index from allItems for referencing
                const originalIndex = allItems.indexOf(item);
                const option = document.createElement('option');
                option.value = originalIndex; // Use original index to reference the item
                option.textContent = item.name;
                option.dataset.category = item.category;
                itemSelect.appendChild(option);
            });
        }

        // =================================================================
        // PERSISTENCE - LocalStorage (TEMPORARY)
        // =================================================================

        /**
         * TEMPORARY: Load inventory from localStorage
         *
         * For testing purposes only. In production, this will be replaced
         * with a proper API call to load the user's inventory from the server.
         *
         * Storage key: 'astoriaInventory'
         * Format: JSON array of inventory items with quantities
         */
        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem('astoriaInventory');
                if (stored) {
                    inventoryItems = JSON.parse(stored);
                    nextItemId = Math.max(...inventoryItems.map(i => i.id), 0) + 1;
                    console.log(`Loaded ${inventoryItems.length} items from localStorage`);
                } else {
                    inventoryItems = [];
                    console.log('No inventory found in localStorage - starting empty');
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                inventoryItems = [];
            }
        }

        /**
         * TEMPORARY: Save inventory to localStorage
         *
         * For testing purposes only. In production, this will be replaced
         * with API calls to persist changes to the server.
         */
        function saveToLocalStorage() {
            try {
                localStorage.setItem('astoriaInventory', JSON.stringify(inventoryItems));
                console.log('Inventory saved to localStorage');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        // =================================================================
        // ADD ITEM PANEL
        // =================================================================

        /**
         * Open the add item panel
         * Pre-selects the current category filter for convenience
         */
        function openAddPanel() {
            addPanel.classList.add('open');

            // Pre-select current category (or "all" if viewing all)
            categorySelect.value = currentCategory;

            // Populate items based on pre-selected category
            populateItemSelector();

            // Reset other form fields
            itemSelect.value = '';
            quantityInput.value = 1;
            itemPreview.style.display = 'none';
        }

        /**
         * Close the add item panel
         */
        function closeAddPanel() {
            addPanel.classList.remove('open');
            resetAddForm();
        }

        /**
         * Reset the add form to defaults
         */
        function resetAddForm() {
            itemSelect.value = '';
            categorySelect.value = 'all';
            quantityInput.value = 1;
            itemPreview.style.display = 'none';
            populateItemSelector(); // Refresh item list
        }

        /**
         * Handle category change - refresh item dropdown
         */
        function handleCategoryChange() {
            // Refresh item dropdown with filtered items
            populateItemSelector();

            // Clear item selection since list changed
            itemSelect.value = '';
            itemPreview.style.display = 'none';
        }

        /**
         * Handle item selection - show preview
         */
        function handleItemSelection() {
            const selectedIndex = itemSelect.value;

            if (!selectedIndex) {
                itemPreview.style.display = 'none';
                return;
            }

            const allItems = getAllItems();
            const selectedItem = allItems[parseInt(selectedIndex)];

            if (selectedItem) {
                // Show preview
                const imageSrc = resolveImage(selectedItem);
                previewImage.src = imageSrc;
                previewImage.onerror = () => { previewImage.src = PLACEHOLDER_IMAGE; };
                previewName.textContent = selectedItem.name;
                previewDescription.textContent = selectedItem.description || 'Aucune description disponible.';
                itemPreview.style.display = 'block';
            }
        }

        /**
         * Add selected item to inventory
         */
        function addItemToInventory() {
            const selectedIndex = itemSelect.value;
            const quantity = parseInt(quantityInput.value) || 1;

            if (!selectedIndex) {
                alert('Veuillez s√©lectionner un objet');
                return;
            }

            if (quantity < 1) {
                alert('La quantit√© doit √™tre au moins 1');
                return;
            }

            const allItems = getAllItems();
            const sourceItem = allItems[parseInt(selectedIndex)];

            if (!sourceItem) {
                alert('Objet invalide');
                return;
            }

            // Check if item already exists in inventory
            const existingItem = inventoryItems.find(i => i.name === sourceItem.name);

            if (existingItem) {
                // Update quantity if already exists
                existingItem.quantity += quantity;
                console.log(`Updated ${existingItem.name}: quantity now ${existingItem.quantity}`);
            } else {
                // Add new item with all data from source (use original category from data)
                const newItem = {
                    id: nextItemId++,
                    name: sourceItem.name,
                    category: sourceItem.category, // Use original category from data
                    image: sourceItem.image,
                    description: sourceItem.description,
                    effect: sourceItem.effect,
                    buyPrice: sourceItem.buyPrice,
                    sellPrice: sourceItem.sellPrice,
                    quantity: quantity
                };

                inventoryItems.push(newItem);
                console.log(`Added ${newItem.name} x${quantity} to inventory`);
            }

            // TEMPORARY: Save to localStorage
            // FUTURE: API call to save to server
            saveToLocalStorage();

            // Close panel and refresh display
            closeAddPanel();
            renderInventory();
        }

        /**
         * Quantity control buttons
         */
        function decreaseQuantity() {
            const current = parseInt(quantityInput.value) || 1;
            quantityInput.value = Math.max(1, current - 1);
        }

        function increaseQuantity() {
            const current = parseInt(quantityInput.value) || 1;
            quantityInput.value = current + 1;
        }

        // Attach event listeners for add panel
        openAddBtn.addEventListener('click', openAddPanel);
        closeAddBtn.addEventListener('click', closeAddPanel);
        cancelAddBtn.addEventListener('click', closeAddPanel);
        confirmAddBtn.addEventListener('click', addItemToInventory);
        categorySelect.addEventListener('change', handleCategoryChange);
        itemSelect.addEventListener('change', handleItemSelection);
        qtyMinusBtn.addEventListener('click', decreaseQuantity);
        qtyPlusBtn.addEventListener('click', increaseQuantity);

        // =================================================================
        // CATEGORY FILTERING
        // =================================================================

        /**
         * Filter inventory by category
         * - Updates active button
         * - Clears selection
         * - Re-renders grid
         */
        function filterByCategory(category) {
            currentCategory = category;
            selectedItemIndex = null;

            // Update active button
            categoryButtons.forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            renderInventory();
        }

        // Attach click handlers to category buttons
        categoryButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                filterByCategory(btn.dataset.category);
            });
        });

        // =================================================================
        // IMAGE RESOLUTION
        // =================================================================

        /**
         * Resolve image path from item data
         * - Checks IMAGE_CONFIG mappings
         * - Supports direct URLs
         * - Falls back to placeholder
         */
        function resolveImage(item) {
            if (!item.image) {
                return PLACEHOLDER_IMAGE;
            }

            // If it's already a full URL or data URI, use it
            if (item.image.startsWith('http') || item.image.startsWith('data:')) {
                return item.image;
            }

            // If it's a direct filename with extension
            if (item.image.includes('.')) {
                return IMAGE_CONFIG.basePath + item.image;
            }

            // Try to find in mappings (normalize name)
            const normalized = item.image
                .toLowerCase()
                .replace(/[^a-z0-9]/g, '');

            if (IMAGE_CONFIG.mappings[normalized]) {
                return IMAGE_CONFIG.basePath + IMAGE_CONFIG.mappings[normalized];
            }

            // Try the item name as fallback
            const normalizedName = item.name
                .toLowerCase()
                .replace(/[^a-z0-9]/g, '');

            if (IMAGE_CONFIG.mappings[normalizedName]) {
                return IMAGE_CONFIG.basePath + IMAGE_CONFIG.mappings[normalizedName];
            }

            // No match found, use placeholder
            return PLACEHOLDER_IMAGE;
        }

        // =================================================================
        // RENDERING
        // =================================================================

        /**
         * Render the entire inventory grid
         * - Filters by current category
         * - Updates item count
         * - Shows empty state if needed
         * - Creates item cards
         */
        function renderInventory() {
            // Filter items by category
            let filtered = inventoryItems;
            if (currentCategory !== 'all') {
                filtered = inventoryItems.filter(item => item.category === currentCategory);
            }

            // Update count (shows currently filtered count)
            itemCountEl.textContent = `${filtered.length} objet${filtered.length > 1 ? 's' : ''}`;

            // Clear grid
            grid.innerHTML = '';

            // Show empty state if no items
            if (filtered.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'flex';
                showDetailPlaceholder();
                return;
            }

            // Show grid
            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            // Render each item
            filtered.forEach((item) => {
                const card = createItemCard(item);
                grid.appendChild(card);
            });
        }

        /**
         * Create an item card element
         * - Resolves image
         * - Shows quantity if > 1
         * - Attaches click handler
         */
        function createItemCard(item) {
            const card = document.createElement('div');
            card.className = 'inventory-item';
            card.dataset.itemId = item.id;

            // Resolve image
            const imageSrc = resolveImage(item);

            card.innerHTML = `
                <div class="item-image">
                    <img src="${escapeHtml(imageSrc)}"
                         alt="${escapeHtml(item.name)}"
                         onerror="this.src='${PLACEHOLDER_IMAGE}'">
                </div>
                <div class="item-info">
                    <div class="item-name">${escapeHtml(item.name)}</div>
                    ${item.quantity > 1 ? `<div class="item-quantity">√ó${item.quantity}</div>` : ''}
                </div>
            `;

            // Click to select
            card.addEventListener('click', () => selectItem(item, card));

            return card;
        }

        // =================================================================
        // ITEM SELECTION & DETAILS
        // =================================================================

        /**
         * Select an item and show its details
         * - Removes previous selection
         * - Marks new selection
         * - Updates detail panel
         */
        function selectItem(item, cardElement) {
            // Remove previous selection
            document.querySelectorAll('.inventory-item').forEach(el => {
                el.classList.remove('selected');
            });

            // Mark as selected
            cardElement.classList.add('selected');
            selectedItemIndex = item.id;

            // Show details
            showItemDetail(item);
        }

        /**
         * Show item details in right panel
         * - Resolves image
         * - Shows all item properties
         */
        function showItemDetail(item) {
            const categoryLabels = {
                'equipement': '‚öîÔ∏è √âquipement',
                'consommable': 'üß™ Consommable',
                'agricole': 'üåæ Agricole'
            };

            const priceInfo = [];
            if (item.buyPrice) priceInfo.push(`Achat: ${item.buyPrice}`);
            if (item.sellPrice) priceInfo.push(`Vente: ${item.sellPrice}`);
            const priceText = priceInfo.length > 0 ? priceInfo.join(' | ') : 'Prix non d√©fini';

            // Resolve image
            const imageSrc = resolveImage(item);

            detailPanel.innerHTML = `
                <div class="detail-header">
                    <h2 class="detail-title">${escapeHtml(item.name)}</h2>
                    <span class="detail-category">${categoryLabels[item.category] || 'Autre'}</span>
                </div>
                <div class="detail-image">
                    <img src="${escapeHtml(imageSrc)}"
                         alt="${escapeHtml(item.name)}"
                         onerror="this.src='${PLACEHOLDER_IMAGE}'">
                </div>
                <div class="detail-body">
                    <div class="detail-section">
                        <span class="detail-label">Description</span>
                        <p class="detail-text">${escapeHtml(item.description || 'Aucune description disponible.')}</p>
                    </div>
                    ${item.effect ? `
                    <div class="detail-section">
                        <span class="detail-label">Effet</span>
                        <p class="detail-text detail-effect">${escapeHtml(item.effect)}</p>
                    </div>
                    ` : ''}
                    <div class="detail-section">
                        <span class="detail-label">Commerce</span>
                        <p class="detail-text">${escapeHtml(priceText)}</p>
                    </div>
                    ${item.quantity > 1 ? `
                    <div class="detail-section">
                        <span class="detail-label">Quantit√©</span>
                        <p class="detail-text">√ó${item.quantity}</p>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        /**
         * Show placeholder when no item selected
         */
        function showDetailPlaceholder() {
            detailPanel.innerHTML = `
                <div class="detail-placeholder">
                    <div class="placeholder-icon">üëÜ</div>
                    <p>S√©lectionnez un objet pour voir ses d√©tails</p>
                </div>
            `;
        }

        // =================================================================
        // UTILITIES
        // =================================================================

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // =================================================================
        // ENTRY POINT
        // =================================================================

        /**
         * Initialize on page load
         */
        window.addEventListener('DOMContentLoaded', initInventory);

        /**
         * Expose API for external use
         * - Can be called from index.html or other pages
         */
        window.InventoryModule = {
            // Current state
            items: () => inventoryItems,

            // Core functions
            renderInventory,
            filterByCategory,

            // Add item from external page (e.g., index.html)
            addItemFromExternal: (itemName, quantity = 1) => {
                const allItems = getAllItems();
                const sourceItem = allItems.find(i => i.name === itemName);

                if (!sourceItem) {
                    console.error(`Item not found: ${itemName}`);
                    return false;
                }

                const existingItem = inventoryItems.find(i => i.name === itemName);

                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    inventoryItems.push({
                        id: nextItemId++,
                        ...sourceItem,
                        quantity: quantity
                    });
                }

                saveToLocalStorage();
                renderInventory();
                return true;
            },

            // Clear entire inventory (for testing)
            clearAll: () => {
                if (confirm('Effacer tout l\'inventaire ?')) {
                    inventoryItems = [];
                    nextItemId = 1;
                    saveToLocalStorage();
                    renderInventory();
                    console.log('Inventory cleared');
                }
            }
        };
    </script>
</body>
</html>
