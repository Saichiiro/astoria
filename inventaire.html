<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaire - Astoria</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Main inventory wrapper -->
    <main class="inventory-wrapper" aria-labelledby="inventoryTitle">
        <!-- Header with title and back button -->
        <div class="inventory-header">
            <a href="index.html" class="back-link" title="Retour √† la liste">‚Üê</a>
            <h1 class="inventory-title" id="inventoryTitle">Inventaire</h1>
            <div class="inventory-actions">
                <span id="itemCount" class="inventory-info">0 objets</span>
                <button class="add-item-btn" id="openAddPanel" title="Ajouter un objet">
                    <span class="add-icon">+</span>
                    <span class="add-label">Ajouter</span>
                </button>
            </div>
        </div>

        <!-- Category filter bar -->
        <nav class="inventory-categories" aria-label="Cat√©gories d'inventaire">
            <button class="category-btn active" data-category="all">
                <span class="category-icon">üì¶</span>
                <span class="category-label">Tous</span>
            </button>
            <button class="category-btn" data-category="equipement">
                <span class="category-icon">‚öîÔ∏è</span>
                <span class="category-label">√âquipements</span>
            </button>
            <button class="category-btn" data-category="consommable">
                <span class="category-icon">üß™</span>
                <span class="category-label">Consommables</span>
            </button>
            <button class="category-btn" data-category="agricole">
                <span class="category-icon">üåæ</span>
                <span class="category-label">Agricole</span>
            </button>
        </nav>

        <!-- Main content area: grid + details -->
        <div class="inventory-content">
            <!-- Items grid (left side) -->
            <div class="inventory-grid-container">
                <div class="inventory-grid" id="inventoryGrid">
                    <!-- Items will be rendered here by JS -->
                </div>
                <div class="empty-inventory" id="emptyState" style="display: none;">
                    <div class="empty-state-icon">üì¶</div>
                    <div class="empty-state-title">Aucun objet</div>
                    <div class="empty-state-message">Votre inventaire est vide dans cette cat√©gorie</div>
                </div>
            </div>

            <!-- Item detail panel (right side) -->
            <div class="inventory-detail" id="itemDetail">
                <div class="detail-placeholder">
                    <div class="placeholder-icon">üëÜ</div>
                    <p>S√©lectionnez un objet pour voir ses d√©tails</p>
                </div>
                <!-- Details will be rendered here when item is selected -->
            </div>
        </div>
    </main>

    <!-- Add item panel (slide-in from right) -->
    <div class="add-panel" id="addPanel">
        <div class="add-panel-inner">
            <div class="add-panel-header">
                <h2>Ajouter un objet</h2>
                <button class="panel-close-btn" id="closeAddPanel">&times;</button>
            </div>

            <div class="add-panel-body">
                <!-- Item selector (from existing database) -->
                <div class="form-group">
                    <label for="itemSelect">Objet *</label>
                    <select id="itemSelect" required>
                        <option value="">-- S√©lectionner un objet --</option>
                        <!-- Options populated by JS from inventoryData -->
                    </select>
                </div>

                <!-- Category selector -->
                <div class="form-group">
                    <label for="categorySelect">Cat√©gorie *</label>
                    <select id="categorySelect" required>
                        <option value="all">üì¶ Toutes cat√©gories</option>
                        <option value="equipement">‚öîÔ∏è √âquipement</option>
                        <option value="consommable">üß™ Consommable</option>
                        <option value="agricole">üåæ Agricole</option>
                    </select>
                </div>

                <!-- Quantity selector -->
                <div class="form-group">
                    <label for="quantityInput">Quantit√© *</label>
                    <div class="quantity-control">
                        <button type="button" class="qty-btn" id="qtyMinus">‚àí</button>
                        <input type="number" id="quantityInput" min="1" value="1">
                        <button type="button" class="qty-btn" id="qtyPlus">+</button>
                    </div>
                </div>

                <!-- Item preview (shows selected item details) -->
                <div id="itemPreview" style="display: none;">
                    <div class="form-group">
                        <label>Aper√ßu</label>
                        <div class="item-preview-card">
                            <img id="previewImage" src="" alt="" style="width: 80px; height: 80px; object-fit: contain;">
                            <div>
                                <div style="font-weight: 600;" id="previewName"></div>
                                <div style="font-size: 14px; color: #666;" id="previewDescription"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="add-panel-footer">
                <button type="button" class="btn-secondary" id="cancelAdd">Annuler</button>
                <button type="button" class="btn-primary" id="confirmAdd">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Delete confirmation modal -->
    <div class="delete-modal-overlay" id="deleteModal">
        <div class="delete-modal">
            <div class="delete-modal-header">
                <h3>Supprimer l'objet</h3>
            </div>
            <div class="delete-modal-body">
                <p>Combien d'unit√©s de <span class="delete-modal-item-name" id="deleteItemName"></span> voulez-vous supprimer ?</p>
                <div class="form-group">
                    <label for="deleteQuantityInput">Quantit√© √† supprimer</label>
                    <div class="quantity-control">
                        <button type="button" class="qty-btn" id="deleteQtyMinus">‚àí</button>
                        <input type="number" id="deleteQuantityInput" min="1" value="1">
                        <button type="button" class="qty-btn" id="deleteQtyPlus">+</button>
                    </div>
                </div>
            </div>
            <div class="delete-modal-footer">
                <button type="button" class="btn-secondary" id="cancelDelete">Annuler</button>
                <button type="button" class="btn-danger" id="confirmDelete">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- Load shared data -->
    <script src="js/image-helpers.js"></script>
    <script src="js/data.js"></script>

    <!-- Inventory-specific JS -->
    <script>
        (function () {
        /**
         * ========================================================================
         * INVENTORY MODULE - EMPTY BY DEFAULT WITH ADD PANEL
         * ========================================================================
         *
         * TEMPORARY IMPLEMENTATION FOR TESTING:
         * - Inventory starts EMPTY on first load
         * - Items stored in localStorage for persistence (testing only)
         * - Items are added via "+" panel which selects from existing database
         * - All item data (name, description, image) comes from data.js
         *
         * FUTURE INTEGRATION:
         * - Replace localStorage with real backend API
         * - Load inventory from server instead of localStorage
         * - Connect to global item management system
         * ========================================================================
         */

        // =================================================================
        // CONFIGURATION
        // =================================================================
        /**
         * IMAGE CONFIGURATION & PLACEHOLDER
         * DÔøΩlÔøΩgÔøΩs au helper global image-helpers.js
         */
        const INVENTORY_IMAGE_HELPERS = window.astoriaImageHelpers || {};
        const PLACEHOLDER_IMAGE = INVENTORY_IMAGE_HELPERS.smallPlaceholder;

        // =================================================================
        // STATE
        // =================================================================

        let currentCategory = 'all';
        let selectedItemIndex = null;
        let inventoryItems = []; // Starts EMPTY
        let nextItemId = 1; // Auto-increment ID for new items

        // =================================================================
        // DOM REFERENCES
        // =================================================================

        const grid = document.getElementById('inventoryGrid');
        const detailPanel = document.getElementById('itemDetail');
        const emptyState = document.getElementById('emptyState');
        const itemCountEl = document.getElementById('itemCount');
        const categoryButtons = document.querySelectorAll('.category-btn');

        // Add panel elements
        const addPanel = document.getElementById('addPanel');
        const openAddBtn = document.getElementById('openAddPanel');
        const closeAddBtn = document.getElementById('closeAddPanel');
        const cancelAddBtn = document.getElementById('cancelAdd');
        const confirmAddBtn = document.getElementById('confirmAdd');
        const itemSelect = document.getElementById('itemSelect');
        const categorySelect = document.getElementById('categorySelect');
        const quantityInput = document.getElementById('quantityInput');
        const qtyMinusBtn = document.getElementById('qtyMinus');
        const qtyPlusBtn = document.getElementById('qtyPlus');
        const itemPreview = document.getElementById('itemPreview');
        const previewImage = document.getElementById('previewImage');
        const previewName = document.getElementById('previewName');
        const previewDescription = document.getElementById('previewDescription');

        // =================================================================
        // INITIALIZATION
        // =================================================================

        /**
         * Initialize inventory - EMPTY BY DEFAULT
         * - Loads from localStorage ONLY (if present)
         * - Otherwise displays empty inventory
         * - Renders the UI
         */
        function initInventory() {
            console.log('Initializing inventory...');

            // TEMPORARY: Load from localStorage for testing
            // FUTURE: Replace with API call to load user's inventory
            loadFromLocalStorage();

            // Render
            renderInventory();

            // Note: Item selector is populated when add panel opens
        }

        // =================================================================
        // ITEM DATABASE ACCESS
        // =================================================================

        /**
         * TEMPORARY FUNCTION: Get all available items from data.js
         *
         * This function accesses our existing central item database (inventoryData).
         * In production, this would query the real backend database.
         *
         * @returns {Array} All available items from the game database
         */
        function getAllItems() {
            if (typeof inventoryData === 'undefined' || !inventoryData) {
                console.warn('inventoryData not found in data.js');
                return [];
            }
            return inventoryData;
        }

        /**
         * Populate the item selector dropdown with items from database
         * Filters by selected category for clarity
         */
        function populateItemSelector() {
            const allItems = getAllItems();
            const selectedCategory = categorySelect.value;

            // Clear existing options (except the first placeholder)
            itemSelect.innerHTML = '<option value="">-- S√©lectionner un objet --</option>';

            // Filter items by category if not "all"
            const filteredItems = selectedCategory === 'all'
                ? allItems
                : allItems.filter(item => item.category === selectedCategory);

            // Add filtered items as options
            filteredItems.forEach((item, index) => {
                // Use the original index from allItems for referencing
                const originalIndex = allItems.indexOf(item);
                const option = document.createElement('option');
                option.value = originalIndex; // Use original index to reference the item
                option.textContent = item.name;
                option.dataset.category = item.category;
                itemSelect.appendChild(option);
            });
        }

        // =================================================================
        // PERSISTENCE - LocalStorage (TEMPORARY)
        // =================================================================

        /**
         * TEMPORARY: Load inventory from localStorage
         *
         * For testing purposes only. In production, this will be replaced
         * with a proper API call to load the user's inventory from the server.
         *
         * Storage key: 'astoriaInventory'
         * Format: JSON array of inventory items with quantities
         */
        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem('astoriaInventory');
                if (stored) {
                    inventoryItems = JSON.parse(stored);
                    nextItemId = Math.max(...inventoryItems.map(i => i.id), 0) + 1;
                    console.log(`Loaded ${inventoryItems.length} items from localStorage`);
                } else {
                    inventoryItems = [];
                    console.log('No inventory found in localStorage - starting empty');
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                inventoryItems = [];
            }
        }

        /**
         * TEMPORARY: Save inventory to localStorage
         *
         * For testing purposes only. In production, this will be replaced
         * with API calls to persist changes to the server.
         */
        function saveToLocalStorage() {
            try {
                localStorage.setItem('astoriaInventory', JSON.stringify(inventoryItems));
                console.log('Inventory saved to localStorage');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        // =================================================================
        // ADD ITEM PANEL
        // =================================================================

        /**
         * Open the add item panel
         * Pre-selects the current category filter for convenience
         */
        function openAddPanel() {
            addPanel.classList.add('open');

            // Pre-select current category (or "all" if viewing all)
            categorySelect.value = currentCategory;

            // Populate items based on pre-selected category
            populateItemSelector();

            // Reset other form fields
            itemSelect.value = '';
            quantityInput.value = 1;
            itemPreview.style.display = 'none';
        }

        /**
         * Close the add item panel
         */
        function closeAddPanel() {
            addPanel.classList.remove('open');
            resetAddForm();
        }

        /**
         * Reset the add form to defaults
         */
        function resetAddForm() {
            itemSelect.value = '';
            categorySelect.value = 'all';
            quantityInput.value = 1;
            itemPreview.style.display = 'none';
            populateItemSelector(); // Refresh item list
        }

        /**
         * Handle category change - refresh item dropdown
         */
        function handleCategoryChange() {
            // Refresh item dropdown with filtered items
            populateItemSelector();

            // Clear item selection since list changed
            itemSelect.value = '';
            itemPreview.style.display = 'none';
        }

        /**
         * Handle item selection - show preview
         */
        function handleItemSelection() {
            const selectedIndex = itemSelect.value;

            if (!selectedIndex) {
                itemPreview.style.display = 'none';
                return;
            }

            const allItems = getAllItems();
            const selectedItem = allItems[parseInt(selectedIndex)];

            if (selectedItem) {
                // Show preview
                const imageSrc = resolveImage(selectedItem);
                previewImage.src = imageSrc;
                previewImage.onerror = () => { previewImage.src = PLACEHOLDER_IMAGE; };
                previewName.textContent = selectedItem.name;
                previewDescription.textContent = selectedItem.description || 'Aucune description disponible.';
                itemPreview.style.display = 'block';
            }
        }

        /**
         * Add selected item to inventory
         */
        function addItemToInventory() {
            const selectedIndex = itemSelect.value;
            const quantity = parseInt(quantityInput.value) || 1;

            if (!selectedIndex) {
                alert('Veuillez s√©lectionner un objet');
                return;
            }

            if (quantity < 1) {
                alert('La quantit√© doit √™tre au moins 1');
                return;
            }

            const allItems = getAllItems();
            const sourceItem = allItems[parseInt(selectedIndex)];

            if (!sourceItem) {
                alert('Objet invalide');
                return;
            }

            // Check if item already exists in inventory
            const existingItem = inventoryItems.find(i => i.name === sourceItem.name);

            if (existingItem) {
                // Update quantity if already exists
                existingItem.quantity += quantity;
                console.log(`Updated ${existingItem.name}: quantity now ${existingItem.quantity}`);
            } else {
                // Add new item with all data from source (use original category from data)
                const newItem = {
                    id: nextItemId++,
                    name: sourceItem.name,
                    category: sourceItem.category, // Use original category from data
                    image: sourceItem.image,
                    description: sourceItem.description,
                    effect: sourceItem.effect,
                    buyPrice: sourceItem.buyPrice,
                    sellPrice: sourceItem.sellPrice,
                    quantity: quantity
                };

                inventoryItems.push(newItem);
                console.log(`Added ${newItem.name} x${quantity} to inventory`);
            }

            // TEMPORARY: Save to localStorage
            // FUTURE: API call to save to server
            saveToLocalStorage();

            // Close panel and refresh display
            closeAddPanel();
            renderInventory();
        }

        /**
         * Quantity control buttons
         */
        function decreaseQuantity() {
            const current = parseInt(quantityInput.value) || 1;
            quantityInput.value = Math.max(1, current - 1);
        }

        function increaseQuantity() {
            const current = parseInt(quantityInput.value) || 1;
            quantityInput.value = current + 1;
        }

        // Attach event listeners for add panel
        openAddBtn.addEventListener('click', openAddPanel);
        closeAddBtn.addEventListener('click', closeAddPanel);
        cancelAddBtn.addEventListener('click', closeAddPanel);
        confirmAddBtn.addEventListener('click', addItemToInventory);
        categorySelect.addEventListener('change', handleCategoryChange);
        itemSelect.addEventListener('change', handleItemSelection);
        qtyMinusBtn.addEventListener('click', decreaseQuantity);
        qtyPlusBtn.addEventListener('click', increaseQuantity);

        // =================================================================
        // CATEGORY FILTERING
        // =================================================================

        /**
         * Filter inventory by category
         * - Updates active button
         * - Clears selection
         * - Re-renders grid
         */
        function filterByCategory(category) {
            currentCategory = category;
            selectedItemIndex = null;

            // Update active button
            categoryButtons.forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            renderInventory();
        }

        // Attach click handlers to category buttons
        categoryButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                filterByCategory(btn.dataset.category);
            });
        });

        // =================================================================
        // IMAGE RESOLUTION
        // =================================================================

        /**
         * Resolve image path from item data
         * - Checks IMAGE_CONFIG mappings
         * - Supports direct URLs
         * - Falls back to placeholder
         */
        function resolveImage(item) {
            const helpers = window.astoriaImageHelpers || {};

            if (helpers.resolveItemImages) {
                const resolved = helpers.resolveItemImages(item);
                if (resolved && resolved.primary) {
                    return resolved.primary;
                }
            }

            // Fallback local (au cas o√π le helper n'est pas disponible)
            if (item && item.image) {
                if (item.image.startsWith('http') || item.image.startsWith('data:')) {
                    return item.image;
                }
            }

            // No match found, use placeholder
            return PLACEHOLDER_IMAGE;
        }

        // =================================================================
        // RENDERING
        // =================================================================

        /**
         * Render the entire inventory grid
         * - Filters by current category
         * - Updates item count
         * - Shows empty state if needed
         * - Creates item cards
         */
        function renderInventory() {
            // Filter items by category
            let filtered = inventoryItems;
            if (currentCategory !== 'all') {
                filtered = inventoryItems.filter(item => item.category === currentCategory);
            }

            // Update count (shows currently filtered count)
            itemCountEl.textContent = `${filtered.length} objet${filtered.length > 1 ? 's' : ''}`;

            // Clear grid
            grid.innerHTML = '';

            // Show empty state if no items
            if (filtered.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'flex';
                showDetailPlaceholder();
                return;
            }

            // Show grid
            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            // Render each item
            filtered.forEach((item) => {
                const card = createItemCard(item);
                grid.appendChild(card);
            });
        }

        /**
         * Create an item card element
         * - Resolves image
         * - Shows quantity if > 1
         * - Attaches click handler
         */
        function createItemCard(item) {
            const card = document.createElement('div');
            card.className = 'inventory-item';
            card.dataset.itemId = item.id;

            // Resolve image
            const imageSrc = resolveImage(item);

            card.innerHTML = `
                <div class="item-image">
                    <img src="${escapeHtml(imageSrc)}"
                         alt="${escapeHtml(item.name)}"
                         onerror="this.src='${PLACEHOLDER_IMAGE}'">
                </div>
                <div class="item-info">
                    <div class="item-name">${escapeHtml(item.name)}</div>
                    ${item.quantity > 1 ? `<div class="item-quantity">√ó${item.quantity}</div>` : ''}
                </div>
            `;

            // Click to select
            card.addEventListener('click', () => selectItem(item, card));

            return card;
        }

        // =================================================================
        // ITEM SELECTION & DETAILS
        // =================================================================

        /**
         * Select an item and show its details
         * - Removes previous selection
         * - Marks new selection
         * - Updates detail panel
         */
        function selectItem(item, cardElement) {
            // Remove previous selection
            document.querySelectorAll('.inventory-item').forEach(el => {
                el.classList.remove('selected');
            });

            // Mark as selected
            cardElement.classList.add('selected');
            selectedItemIndex = item.id;

            // Show details
            showItemDetail(item);
        }

        /**
         * Show item details in right panel
         * - Resolves image
         * - Shows all item properties
         */
        function showItemDetail(item) {
            const categoryLabels = {
                'equipement': '‚öîÔ∏è √âquipement',
                'consommable': 'üß™ Consommable',
                'agricole': 'üåæ Agricole'
            };

            const priceInfo = [];
            if (item.buyPrice) priceInfo.push(`Achat: ${item.buyPrice}`);
            if (item.sellPrice) priceInfo.push(`Vente: ${item.sellPrice}`);
            const priceText = priceInfo.length > 0 ? priceInfo.join(' | ') : 'Prix non d√©fini';

            // Resolve image
            const imageSrc = resolveImage(item);

            detailPanel.innerHTML = `
                <div class="detail-header">
                    <div class="detail-title-wrapper">
                        <h2 class="detail-title">${escapeHtml(item.name)}</h2>
                        <span class="detail-category">${categoryLabels[item.category] || 'Autre'}</span>
                    </div>
                    <div class="detail-actions">
                        <button class="item-action-use"
                                onclick="useItem(${item.id})"
                                title="Utiliser l'objet"
                                ${item.quantity < 1 ? 'disabled' : ''}
                                aria-label="Utiliser l'objet">
                            ‚úì
                        </button>
                        <button class="item-action-delete"
                                onclick="openDeleteModal(${item.id})"
                                title="Supprimer l'objet"
                                aria-label="Supprimer l'objet">
                            üóë
                        </button>
                    </div>
                </div>
                <div class="detail-image">
                    <img src="${escapeHtml(imageSrc)}"
                         alt="${escapeHtml(item.name)}"
                         onerror="this.src='${PLACEHOLDER_IMAGE}'">
                </div>
                <div class="detail-body">
                    <div class="detail-section">
                        <span class="detail-label">Description</span>
                        <p class="detail-text">${escapeHtml(item.description || 'Aucune description disponible.')}</p>
                    </div>
                    ${item.effect ? `
                    <div class="detail-section">
                        <span class="detail-label">Effet</span>
                        <p class="detail-text detail-effect">${escapeHtml(item.effect)}</p>
                    </div>
                    ` : ''}
                    <div class="detail-section">
                        <span class="detail-label">Commerce</span>
                        <p class="detail-text">${escapeHtml(priceText)}</p>
                    </div>
                    ${item.quantity > 1 ? `
                    <div class="detail-section">
                        <span class="detail-label">Quantit√©</span>
                        <p class="detail-text">√ó${item.quantity}</p>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        /**
         * Show placeholder when no item selected
         */
        function showDetailPlaceholder() {
            detailPanel.innerHTML = `
                <div class="detail-placeholder">
                    <div class="placeholder-icon">üëÜ</div>
                    <p>S√©lectionnez un objet pour voir ses d√©tails</p>
                </div>
            `;
        }

        // =================================================================
        // ITEM ACTIONS (USE & DELETE)
        // =================================================================

        // Delete modal elements
        const deleteModal = document.getElementById('deleteModal');
        const deleteItemNameEl = document.getElementById('deleteItemName');
        const deleteQuantityInput = document.getElementById('deleteQuantityInput');
        const deleteQtyMinusBtn = document.getElementById('deleteQtyMinus');
        const deleteQtyPlusBtn = document.getElementById('deleteQtyPlus');
        const cancelDeleteBtn = document.getElementById('cancelDelete');
        const confirmDeleteBtn = document.getElementById('confirmDelete');

        let currentDeleteItemId = null;
        let currentDeleteItemMaxQty = 0;

        /**
         * Use an item - decreases quantity by 1
         * - Finds item by ID
         * - Decreases quantity by 1
         * - If quantity reaches 0, removes item
         * - Saves to localStorage
         * - Re-renders grid and details
         */
        function useItem(itemId) {
            const itemIndex = inventoryItems.findIndex(i => i.id === itemId);
            if (itemIndex === -1) return;

            const item = inventoryItems[itemIndex];

            if (item.quantity < 1) {
                alert('Quantit√© insuffisante pour utiliser cet objet');
                return;
            }

            // Decrease quantity
            item.quantity -= 1;

            console.log(`Used ${item.name}. Quantity now: ${item.quantity}`);

            // If quantity reaches 0, remove item
            if (item.quantity <= 0) {
                inventoryItems.splice(itemIndex, 1);
                selectedItemIndex = null;
                showDetailPlaceholder();
            } else {
                // Refresh the detail view to update quantity display
                showItemDetail(item);
            }

            // Save to localStorage
            saveToLocalStorage();

            // Re-render grid
            renderInventory();
        }

        /**
         * Open delete confirmation modal
         * - Sets current item ID
         * - Shows item name
         * - Resets quantity input to 1
         * - Sets max quantity
         * - Opens modal
         */
        function openDeleteModal(itemId) {
            const item = inventoryItems.find(i => i.id === itemId);
            if (!item) return;

            currentDeleteItemId = itemId;
            currentDeleteItemMaxQty = item.quantity;

            // Update modal content
            deleteItemNameEl.textContent = item.name;
            deleteQuantityInput.value = 1;
            deleteQuantityInput.max = item.quantity;

            // Open modal
            deleteModal.classList.add('open');
        }

        /**
         * Close delete modal
         */
        function closeDeleteModal() {
            deleteModal.classList.remove('open');
            currentDeleteItemId = null;
            currentDeleteItemMaxQty = 0;
        }

        /**
         * Confirm deletion from modal
         * - Gets quantity to delete
         * - Updates item quantity or removes item
         * - Saves to localStorage
         * - Re-renders grid
         */
        function confirmDeletion() {
            if (!currentDeleteItemId) return;

            const qtyToDelete = parseInt(deleteQuantityInput.value) || 1;

            if (qtyToDelete < 1) {
                alert('La quantit√© doit √™tre au moins 1');
                return;
            }

            if (qtyToDelete > currentDeleteItemMaxQty) {
                alert(`La quantit√© maximum est ${currentDeleteItemMaxQty}`);
                return;
            }

            const itemIndex = inventoryItems.findIndex(i => i.id === currentDeleteItemId);
            if (itemIndex === -1) return;

            const item = inventoryItems[itemIndex];

            // Update quantity or remove item
            if (qtyToDelete >= item.quantity) {
                // Remove item entirely
                inventoryItems.splice(itemIndex, 1);
                selectedItemIndex = null;
                showDetailPlaceholder();
                console.log(`Deleted ${item.name} completely`);
            } else {
                // Decrease quantity
                item.quantity -= qtyToDelete;
                showItemDetail(item);
                console.log(`Deleted ${qtyToDelete} of ${item.name}. Remaining: ${item.quantity}`);
            }

            // Save to localStorage
            saveToLocalStorage();

            // Close modal and re-render
            closeDeleteModal();
            renderInventory();
        }

        /**
         * Decrease delete quantity
         */
        function decreaseDeleteQuantity() {
            const current = parseInt(deleteQuantityInput.value) || 1;
            deleteQuantityInput.value = Math.max(1, current - 1);
        }

        /**
         * Increase delete quantity
         */
        function increaseDeleteQuantity() {
            const current = parseInt(deleteQuantityInput.value) || 1;
            const max = currentDeleteItemMaxQty;
            deleteQuantityInput.value = Math.min(max, current + 1);
        }

        // Attach event listeners for delete modal
        deleteQtyMinusBtn.addEventListener('click', decreaseDeleteQuantity);
        deleteQtyPlusBtn.addEventListener('click', increaseDeleteQuantity);
        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        confirmDeleteBtn.addEventListener('click', confirmDeletion);

        // Close modal when clicking outside
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                closeDeleteModal();
            }
        });

        // Make functions globally accessible for onclick handlers
        window.useItem = useItem;
        window.openDeleteModal = openDeleteModal;

        // =================================================================
        // ITEM DELETION (OLD - KEPT FOR COMPATIBILITY)
        // =================================================================

        /**
         * Delete an item from inventory
         * - Removes from array
         * - Saves to localStorage
         * - Clears selection
         * - Re-renders grid
         */
        function deleteItem(itemId) {
            const itemIndex = inventoryItems.findIndex(i => i.id === itemId);
            if (itemIndex === -1) return;

            const itemName = inventoryItems[itemIndex].name;

            // Confirm deletion
            if (!confirm(`Supprimer "${itemName}" de l'inventaire ?`)) {
                return;
            }

            // Remove from array
            inventoryItems.splice(itemIndex, 1);

            // Save to localStorage
            saveToLocalStorage();

            // Clear selection
            selectedItemIndex = null;
            showDetailPlaceholder();

            // Re-render
            renderInventory();
        }

        // Make deleteItem globally accessible for onclick
        window.deleteItem = deleteItem;

        // =================================================================
        // UTILITIES
        // =================================================================

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // =================================================================
        // ENTRY POINT
        // =================================================================

        /**
         * Initialize on page load
         */
        window.addEventListener('DOMContentLoaded', initInventory);

        /**
         * Expose API for external use
         * - Can be called from index.html or other pages
         */
        window.InventoryModule = {
            // Current state
            items: () => inventoryItems,

            // Core functions
            renderInventory,
            filterByCategory,

            // Add item from external page (e.g., index.html)
            addItemFromExternal: (itemName, quantity = 1) => {
                const allItems = getAllItems();
                const sourceItem = allItems.find(i => i.name === itemName);

                if (!sourceItem) {
                    console.error(`Item not found: ${itemName}`);
                    return false;
                }

                const existingItem = inventoryItems.find(i => i.name === itemName);

                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    inventoryItems.push({
                        id: nextItemId++,
                        ...sourceItem,
                        quantity: quantity
                    });
                }

                saveToLocalStorage();
                renderInventory();
                return true;
            },

            // Clear entire inventory (for testing)
            clearAll: () => {
                if (confirm('Effacer tout l\'inventaire ?')) {
                    inventoryItems = [];
                    nextItemId = 1;
                    saveToLocalStorage();
                    renderInventory();
                    console.log('Inventory cleared');
                }
            }
        };
        })();
    </script>
</body>
</html>
