<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cropper.js Test - Astoria</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .upload-section {
            margin-bottom: 24px;
        }

        .upload-btn {
            padding: 12px 24px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        .upload-btn:hover {
            background: #357abd;
        }

        #fileInput {
            display: none;
        }

        .cropper-container-wrapper {
            margin-bottom: 24px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            background: #fafafa;
        }

        #cropperImage {
            max-width: 100%;
            display: block;
        }

        .toolbar {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tool-btn {
            width: 48px;
            height: 48px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-btn:hover {
            background: #f8f9fa;
            border-color: #bbb;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tool-btn:active {
            transform: translateY(0);
            background: #e9ecef;
        }

        .divider {
            width: 1px;
            height: 40px;
            background: #ddd;
            margin: 0 4px;
        }

        .actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
        }

        .action-btn {
            padding: 12px 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .action-btn.primary {
            background: #4a90e2;
            color: white;
        }

        .action-btn.primary:hover {
            background: #357abd;
        }

        .action-btn.secondary {
            background: #e9ecef;
            color: #2c3e50;
        }

        .action-btn.secondary:hover {
            background: #dee2e6;
        }

        .result-section {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 2px solid #e9ecef;
        }

        #resultImage {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .hint {
            text-align: center;
            color: #6c757d;
            font-size: 14px;
            margin-top: 12px;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .info-box h3 {
            margin-bottom: 8px;
            color: #1976d2;
        }

        .info-box ul {
            margin-left: 20px;
            color: #424242;
        }

        .controls-row {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-toggle {
            display: flex;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .mode-btn.active {
            background: #4a90e2;
            color: white;
        }

        .mode-btn:hover:not(.active) {
            background: #f8f9fa;
        }

        .crop-info {
            display: flex;
            gap: 16px;
            padding: 8px 16px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
            color: #424242;
            font-family: 'Courier New', monospace;
        }

        .crop-info span {
            font-weight: 600;
        }

        .zoom-display {
            min-width: 60px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            font-family: 'Courier New', monospace;
        }

        .zoom-slider-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            max-width: 400px;
        }

        .zoom-slider-wrapper input[type="range"] {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è Cropper.js Test - Proper Features</h1>

        <div class="info-box">
            <h3>Features Enabled:</h3>
            <ul>
                <li><strong>Resizable Crop Box</strong> - Drag corners/edges to any size</li>
                <li><strong>Movable Crop Box</strong> - Drag to reposition</li>
                <li><strong>Crosshair Guides</strong> - Precision alignment lines</li>
                <li><strong>Center Indicator</strong> - Shows crop box center</li>
                <li><strong>Grid Background</strong> - Composition guide</li>
                <li><strong>Free Aspect Ratio</strong> - No constraints!</li>
                <li><strong>Mouse Wheel Zoom</strong> - Scroll to zoom in/out</li>
            </ul>
        </div>

        <div class="upload-section">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                üìÅ Select Image
            </button>
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <div class="cropper-container-wrapper" id="cropperWrapper" style="display: none;">
            <img id="cropperImage" alt="Image to crop">

            <div class="toolbar">
                <button class="tool-btn" id="rotateLeft">‚Ü∫</button>
                <button class="tool-btn" id="rotateRight">‚Üª</button>
                <button class="tool-btn" id="flipH">‚Üî</button>
                <button class="tool-btn" id="flipV">‚Üï</button>

                <div class="divider"></div>

                <button class="tool-btn" id="zoomIn">+</button>
                <button class="tool-btn" id="zoomOut">‚àí</button>

                <div class="divider"></div>

                <button class="tool-btn" id="reset">‚Ü∫</button>
            </div>

            <div class="controls-row">
                <div class="zoom-slider-wrapper">
                    <span class="zoom-display" id="zoomDisplay">100%</span>
                    <input type="range" id="zoomSlider" min="10" max="300" value="100" step="1">
                </div>
            </div>

            <p class="hint">Drag corners/edges to resize ‚Ä¢ Drag to move ‚Ä¢ Mouse wheel or slider to zoom</p>
        </div>

        <div class="actions" id="actions" style="display: none;">
            <button class="action-btn secondary" id="cancel">Cancel</button>
            <button class="action-btn primary" id="crop">‚úì Crop & Download</button>
        </div>

        <div class="result-section" id="resultSection" style="display: none;">
            <h2>Result:</h2>
            <img id="resultImage" alt="Cropped result">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
    <script>
        let cropper = null;
        let scaleX = 1, scaleY = 1;
        let baseZoom = 1; // Store the initial "fit to container" zoom level

        const fileInput = document.getElementById('fileInput');
        const cropperImage = document.getElementById('cropperImage');
        const cropperWrapper = document.getElementById('cropperWrapper');
        const actions = document.getElementById('actions');
        const resultSection = document.getElementById('resultSection');
        const resultImage = document.getElementById('resultImage');

        // File upload handler
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Destroy existing cropper
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }

            // Load image
            const reader = new FileReader();
            reader.onload = (event) => {
                cropperImage.src = event.target.result;
                cropperWrapper.style.display = 'block';
                actions.style.display = 'flex';
                resultSection.style.display = 'none';

                // Initialize Cropper.js with ENHANCED configuration
                cropper = new Cropper(cropperImage, {
                    viewMode: 1,              // Restrict crop box to canvas, but allow canvas to be smaller
                    dragMode: 'move',         // Move image, not crop box (default)
                    aspectRatio: NaN,         // FREE aspect ratio
                    autoCropArea: 0.8,        // 80% initial crop area
                    restore: true,            // Restore after window resize
                    guides: true,             // Crosshair guides ‚úì
                    center: true,             // Center indicator ‚úì
                    highlight: true,          // Highlight crop box ‚úì
                    cropBoxMovable: true,     // Move crop box ‚úì
                    cropBoxResizable: true,   // Resize crop box ‚úì
                    toggleDragModeOnDblclick: false, // Manual mode control
                    background: true,         // Grid background ‚úì
                    responsive: true,
                    checkOrientation: true,
                    modal: true,              // Dark overlay around crop box
                    minCropBoxWidth: 50,      // Minimum crop box size
                    minCropBoxHeight: 50,
                    wheelZoomRatio: 0.1,      // Smooth wheel zoom
                    movable: true,            // Enable moving
                    zoomable: true,           // Enable zooming
                    rotatable: true,          // Enable rotation
                    scalable: true,           // Enable scaling
                    ready() {
                        console.log('Cropper ready with enhanced features!');
                        // Store the initial zoom as the base (this is 100%)
                        const imageData = cropper.getImageData();
                        baseZoom = imageData.width / imageData.naturalWidth;
                        updateCropInfo();
                    },
                    crop() {
                        // Update info on every crop change
                        updateCropInfo();
                    },
                    zoom() {
                        updateCropInfo();
                    }
                });

                scaleX = 1;
                scaleY = 1;
            };
            reader.readAsDataURL(file);
        });

        // Toolbar controls
        document.getElementById('rotateLeft').addEventListener('click', () => {
            if (cropper) cropper.rotate(-90);
        });

        document.getElementById('rotateRight').addEventListener('click', () => {
            if (cropper) cropper.rotate(90);
        });

        document.getElementById('flipH').addEventListener('click', () => {
            if (cropper) {
                scaleX = -scaleX;
                cropper.scaleX(scaleX);
            }
        });

        document.getElementById('flipV').addEventListener('click', () => {
            if (cropper) {
                scaleY = -scaleY;
                cropper.scaleY(scaleY);
            }
        });

        document.getElementById('zoomIn').addEventListener('click', () => {
            if (cropper) cropper.zoom(0.1);
        });

        document.getElementById('zoomOut').addEventListener('click', () => {
            if (cropper) cropper.zoom(-0.1);
        });

        document.getElementById('reset').addEventListener('click', () => {
            if (cropper) {
                cropper.reset();
                scaleX = 1;
                scaleY = 1;
            }
        });

        function updateCropInfo() {
            if (!cropper) return;

            const imageData = cropper.getImageData();
            const currentZoom = imageData.width / imageData.naturalWidth;
            // Calculate zoom percentage relative to the initial fit (baseZoom = 100%)
            const zoomPercent = Math.round((currentZoom / baseZoom) * 100);

            document.getElementById('zoomDisplay').textContent = zoomPercent + '%';
            document.getElementById('zoomSlider').value = zoomPercent;
        }

        // Zoom slider control
        const zoomSlider = document.getElementById('zoomSlider');
        if (zoomSlider) {
            zoomSlider.addEventListener('input', (e) => {
                if (!cropper) return;
                const targetPercent = parseInt(e.target.value) / 100; // Slider value as percentage (1.0 = 100%)
                const targetZoom = baseZoom * targetPercent; // Scale relative to base zoom
                cropper.zoomTo(targetZoom);
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (!cropper) return;

            // Ignore if typing in input
            if (e.target.tagName === 'INPUT') return;

            const step = e.shiftKey ? 10 : 1; // Hold shift for faster movement

            switch(e.key.toLowerCase()) {
                case 'arrowleft':
                    e.preventDefault();
                    cropper.move(-step, 0);
                    break;
                case 'arrowright':
                    e.preventDefault();
                    cropper.move(step, 0);
                    break;
                case 'arrowup':
                    e.preventDefault();
                    cropper.move(0, -step);
                    break;
                case 'arrowdown':
                    e.preventDefault();
                    cropper.move(0, step);
                    break;
                case '+':
                case '=':
                    e.preventDefault();
                    cropper.zoom(0.1);
                    break;
                case '-':
                case '_':
                    e.preventDefault();
                    cropper.zoom(-0.1);
                    break;
                case 'q':
                    e.preventDefault();
                    cropper.rotate(-90);
                    break;
                case 'e':
                    e.preventDefault();
                    cropper.rotate(90);
                    break;
                case 'h':
                    e.preventDefault();
                    scaleX = -scaleX;
                    cropper.scaleX(scaleX);
                    break;
                case 'v':
                    e.preventDefault();
                    scaleY = -scaleY;
                    cropper.scaleY(scaleY);
                    break;
                case 'r':
                    e.preventDefault();
                    cropper.reset();
                    scaleX = 1;
                    scaleY = 1;
                    break;
            }
        });

        // Action buttons
        document.getElementById('cancel').addEventListener('click', () => {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            cropperWrapper.style.display = 'none';
            actions.style.display = 'none';
            resultSection.style.display = 'none';
            fileInput.value = '';
        });

        document.getElementById('crop').addEventListener('click', () => {
            if (!cropper) return;

            const canvas = cropper.getCroppedCanvas({
                maxWidth: 4096,
                maxHeight: 4096,
                fillColor: '#fff',
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });

            if (canvas) {
                // Show result
                resultImage.src = canvas.toDataURL('image/jpeg', 0.92);
                resultSection.style.display = 'block';

                // Download
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'cropped-image.jpg';
                    a.click();
                    URL.revokeObjectURL(url);
                }, 'image/jpeg', 0.92);
            }
        });
    </script>
</body>
</html>
